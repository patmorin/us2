\documentclass{patmorin}
\listfiles


\definecolor{brightmaroon}{rgb}{0.76, 0.13, 0.28}
\definecolor{linkblue}{rgb}{0, 0.337, 0.227}
\newcommand{\defin}[1]{\emph{\color{brightmaroon}#1}}
\setlength{\parskip}{1ex}

\DeclareMathOperator{\comp}{comp}

\title{\MakeUppercase{A Unique Superior is Still One Too Many}}
\author{Bra\v{c} 2023 Gang}


\newcommand{\rn}[1]{\chi_{\operatorname{#1-vr}}}
\newcommand{\irn}{\rn{\infty}}
% \newcommand{\trn}{\rn{2}}
\newcommand{\trn}{\chi_{\mathrm{us}}}
\newcommand{\lrn}{\rn{\ell}}
\newcommand{\dtcn}{\bar{\chi}_2}
\newcommand{\dlcn}{\bar{\chi}_\ell}
\newcommand{\scn}{\chi_{\star}}

\newcommand{\texp}{1-1/(\lfloor\ell/2\rfloor+1/2)}
\newcommand{\dexp}{1-\frac{1}{\lfloor\ell/2\rfloor+1/2}}

% \pagenumbering{roman}
\begin{document}

\maketitle

\begin{abstract}
  An $\ell$-vertex-ranking of a graph $G$ is a colouring of the vertices of $G$ with integer colours so that in any connected subgraph of $G$ of diameter at most $\ell$ there is a uniqe vertex whose colour is maximum.  The $\ell$-vertex-ranking number, $\lrn(G)$, of $G$ is the minimum integer $k$ such that $G$ has an $\ell$-vertex-ranking using $k$-colours.  We prove that, for any fixed $d$ and $\ell$, every $d$-degenerate $n$-vertex graph $G$ has $\lrn(G)=O(n^{1-2/(\ell+1)}\log n)$ if $\ell$ is even and $\lrn(G)=O(n^{1-2/\ell}\log n)$ if $\ell$ is odd. The case $\ell=2$ resolves (up to the $\log n$ factor) an open problem posed by \citet{karpas.neiman.ea:on}.
  % A \defin{unique-superior colouring} (also known as a \defin{$2$-vertex-ranking} or \defin{restricted star colouring}) is a mapping $\varphi:V(G)\to\N$ of the vertices of a graph $G$ to integer colours so that for any edge $uv$, $\varphi(u)\neq \varphi(v)$ and for any $3$-vertex path $uvw$, $\phi(u)\neq\varphi(w)$ or $\varphi(v)>\varphi(u)$.  For a graph $G$, the \defin{unique-superior chromatic number} $\trn(G)$ is the minimum value of $k$ such that $G$ has a unique-superior colouring $\varphi:V(G)\to\{1,\ldots,k\}$.  We show that there exists a constant $c$ such that every $n$-vertex $d$-degenerate graph $G$ has $\trn(G) \le cd^{4/3}(n\log n)^{1/3}$.  This almost matches the lower bound of $\Omega(n^{1/3})$ for $2$-degenerate graphs and significantly improves the previous upper bound of $O(\sqrt{dn})$ for $d$-degenerate graphs---both given by \citet{karpas.neiman.ea:on}. These results extend to the \defin{$\ell$-vertex-ranking} problem in which one considers all paths $v_0,\ldots,v_r$ of length $r\le \ell$ and requires that $\varphi(v_0)\neq\varphi(v_r)$ or that $\varphi(v_0)<\max\{\varphi(v_1),\ldots,\varphi(v_{r-1})\}$.  In this setting, for any fixed $\ell$ and $d$, the bound on the $\ell$-vertex-ranking number $\lrn(G)$ for any $d$-degenerate graph $G$ is $O(n^{(\ell-3/2)/(\ell-1/2)}\log n)$.
\end{abstract}


% \tableofcontents
%
% \newpage
% \pagenumbering{arabic}



\section{Introduction}

% A \defin{unique-superior colouring} (also known as a \defin{$2$-vertex-ranking} or \defin{restricted star colouring}) is a mapping $\varphi:V(G)\to\N$ of the vertices of a graph $G$ to integer colours so that for any edge $uv$, $\varphi(u)\neq \varphi(v)$ and for any $3$-vertex path $uvw$, $\varphi(u)\neq\varphi(w)$ or $\varphi(v)>\varphi(u)$.  For a graph $G$, the unique-superior chromatic number $\trn(G)$ is the minimum value of $k$ such that $G$ has a unique-superior colouring $\varphi:V(G)\to\{1,\ldots,k\}$.
%
% \citet{karpas.neiman.ea:on}  showed that for every $d$-degenerate\footnote{A graph $G$ is \defin{$d$-degenerate} if every non-empty subgraph of $G$ has a vertex of degree at most $d$.  Equivalently, $G$ is $d$-degenerate if it has a vertex ordering in which each vertex precedes at most $d$ of its neighbours in the ordering.} $n$-vertex graph $G$, $\trn(G)\in O(\sqrt{dn})$ and that there exists $2$-degenerate $n$-vertex graphs with $\trn(G)\in\Omega(n^{1/3})$.\footnote{In \cite[Theorem~6.2]{karpas.neiman.ea:on} the authors prove the bound $O(d\sqrt{n})$, but an easy optimization of their argument (separately colouring all vertices of degree greater than $\sqrt{n/d}$ with distinct large colours) improves this to $O(\sqrt{dn})$.}  They leave the question of closing the gap between these bounds as an open problem and this question is stated again by \citet{bose.dujmovic.ea:asymptotically}.
% In the current paper we give a colouring procedure that essentially matches their lower bound to within a polylogarithmic factor.  In particular, for fixed $d$, $\trn(G)\in O((n\log n)^{1/3})$.
%
% \begin{thm}\label{d_degenerate_upper_bound}
%   There exists a constant $c>0$ such that for any integer $d\ge 1$, every $n$-vertex $d$-degenerate graph $G$ has $\trn(G) \le c d^{4/3}(n\log n)^{1/3}$.
% \end{thm}
%
% Like the upper bound in \cite{karpas.neiman.ea:on}, \cref{d_degenerate_upper_bound} follows quickly from a theorem about graphs that are both $d$-degenerate and have maximum-degree $\Delta$. For such graphs, we prove:
%
% \begin{thm}\label{degenerate_and_degree}
%   There exists a constant $c>0$ such that
%   for all integers $\Delta\ge d \ge 1$, and $n> \Delta$, every $d$-degenerate $n$-vertex graph $G$ of maximum degree at most $\Delta$ has
%   $\trn(G)\leq cd^{3/2}\sqrt{\Delta}\log^{3/2} n$.
% \end{thm}
%
% \Cref{d_degenerate_upper_bound} follows easily from \cref{degenerate_and_degree}, by the following argument:  Since $G$ is $d$-degenerate, it has at most $dn$ edges and the sum of its vertex degrees is at most $2dn$.  Let $\Delta:=d^{-1/3}n^{2/3}\log^{-1/3} n$.  Then the set $S:=\{v\in V(G):\deg_G(v)\ge \Delta\}$ has size at most $2dn/\Delta=2d^{4/3}n^{1/3}\log^{1/3} n$.  Since $G-S$ has maximum degree $\Delta$, $G-S$ has a unique-superior colouring $\varphi$ using at most
% \[
%   cd^{3/2}\sqrt{\Delta}\log^{1/2} n
%   % = c\cdot \sqrt{\frac{n^{2/3}}{d^{1/3}\log^{1/2} n}}\cdot \log^{3/4} n
%   = c d^{\tfrac{3}{2}-\tfrac{1}{6}}n^{\tfrac{1}{3}}\log^{\tfrac{1}{2}-\tfrac{1}{6}} n
%   = c d^{\tfrac{4}{3}}(n\log n)^{\tfrac{1}{3}}
% \]
% colours, by \cref{degenerate_and_degree}. We can extend $\varphi$ to a colouring of $G$ by assigning each vertex in $S$ a distinct colour that is larger than every colour used in the colouring of $G-S$.  Thus, $\trn(G)\le |S|+\trn(G-S)\le (2+c)d^{4/3}(n\log n)^{1/3}$, which establishes \cref{d_degenerate_upper_bound}.

A vertex colouring $\varphi$ of $G$ is an \defin{$\ell$-vertex-ranking} of $G$ if, for each path $v_0,\ldots,v_r$ in $G$ with $1\le r\le\ell$ edges, $\varphi(v_0)\neq \varphi(v_r)$ or $\max\{\varphi(v_1),\ldots,\varphi(v_{r-1})\}>\varphi(v_0)$.  The \defin{$\ell$-vertex-ranking} number $\lrn(G)$ is the minimum integer $k$ such that $G$ has a vertex $\ell$-ranking $\varphi:V(G)\to\{1,\ldots,k\}$.

\todo[inline]{Add discussion about previous works, including the upper and lower bounds for $d$-degenerate graphs in \cite{karpas.neiman.ea:on}.  Most of this is covered in the introduction to \cite{bose.dujmovic.ea:asymptotically}.}

% Note that $\varphi$ is a $2$-vertex ranking of $G$ if and only if it is a unique-superior colouring of $G$, so $\trn(G)=\rn{2}(G)$ for every graph $G$.
We establish the following upper bound for the $\ell$-vertex-ranking number of $d$-degenerate graphs:

\begin{thm}\label{l_d_degenerate_upper_bound}
  For any positive integers $d$ and $\ell$ there exists a constant $c:=c(d,\ell)$ such that, for every integer $n\ge d$, every $n$-vertex $d$-degenerate graph $G$ has
  \[
    \lrn(G)\le c n^{\dexp}\log n
    = \begin{cases}
      cn^{1-\frac{2}{\ell}}\log n & \text{if $\ell$ is odd} \\
      cn^{1-\frac{2}{\ell+1}}\log n & \text{if $\ell$ is even.}
      \end{cases}
  \]
\end{thm}
Somewhat surprisingly, the bound in \cref{l_d_degenerate_upper_bound} is the same for $\ell=2k$ and $\ell=2k+1$, for any positive integer $k$.  One might think that this is just an artifact of the proof technique.  However, \citet{karpas.neiman.ea:on} proved the existence of $2$-degenerate $n$-vertex graphs with $\rn{2}(G)\in\Omega(n^{1/3})$ and \cref{l_d_degenerate_upper_bound} (with $\ell=2$) matches this lower bound to within a logarithmic factor.  Since $\rn{3}(G)\ge\trn(G)$ for any graph $G$, it also matches this bound when $\ell=3$.  Thus, \cref{l_d_degenerate_upper_bound} is quasi-tight for $\ell=2$ and $\ell=3$, leading us to suspect that it is tight for any fixed $\ell$.


Like the upper bound on $\rn{2}(G)$ in \cite{karpas.neiman.ea:on}, \cref{l_d_degenerate_upper_bound} follows quickly from a theorem about graphs that are both $d$-degenerate and have maximum-degree $\Delta$. For such graphs, we prove:

\begin{thm}\label{l_degenerate_and_degree}
  For all positive integers $d$ and $\ell\ge 2$ there exists a constant $c:=c(d,\ell)$ such that, for every integer $\Delta\ge d$, every integer $n\ge \Delta$, every $n$-vertex $d$-degenerate graph $G$ of maximum-degree at most $\Delta$ has $\lrn(G)\le c\Delta^{\lfloor\ell/2\rfloor-1/2}\log^{5/4} n$.  Furthermore, if $\Delta^{\lfloor\ell/2\rfloor-1}\ge\log n$ then $\lrn(G)\le c\Delta^{\lfloor\ell/2\rfloor-1/2}\log n$.
  % \[
  %    \lrn(G) \le \begin{cases}
  %                   c\Delta^{\lfloor\ell/2\rfloor-1/2}\log^{5/4} n
  %                     & \text{for $\ell\in\{2,3\}$} \\
  %                   c\Delta^{\lfloor\ell/2\rfloor-1/2}\log n
  %                     & \text{for $\ell\ge 4}
  %                 \end{cases}
  % \]
\end{thm}

\Cref{l_d_degenerate_upper_bound} follows easily from \cref{l_degenerate_and_degree}, by the following argument:  Since $G$ is $d$-degenerate, it has at most $dn$ edges and the sum of its vertex degrees is at most $2dn$.  $\Delta:=n^{1/(\lfloor\ell/2\rfloor+1/2)}\log^{-x} n$ for some value $x$ to be discussed shortly.  Then the set $S:=\{v\in V(G):\deg_G(v)\ge \Delta\}$ has size at most $2dn/\Delta=2dn^{\texp}\log^x n$.  Since $G-S$ is $d$-degenerate and has maximum degree $\Delta$, \cref{l_degenerate_and_degree} implies that
\begin{align*}
  \lrn(G-S) &
  \le c\Delta^{\lfloor\ell/2\rfloor-1/2}\log^{5/4} n \\
  % cd^{3/2}\sqrt{\Delta}\log^{1/2} n
  % = c\cdot \sqrt{\frac{n^{2/3}}{d^{1/3}\log^{1/2} n}}\cdot \log^{3/4} n
  & = cn^{\frac{\lfloor\ell/2\rfloor-1/2}{\lfloor\ell/2\rfloor+1/2}}\log^{5/4-x(\lfloor\ell/2\rfloor-1/2)} n \\
  & = cn^{\dexp}\log^{5/4-x(\lfloor\ell/2\rfloor-1/2)} n \\
  & \le cn^{\dexp}\log^{5/4-x/2} n \\
  % & = O\left(n^{\dexp}\right)
\end{align*}
where the last inequality follows from the fact that $\lfloor\ell/2\rfloor-1/2\ge 1/2$ for all $\ell\ge 2$.  Taking $x:=5/6$, we get $|S|=O(n^{\texp}\log^{5/6} n)=O(n^{\texp}\log n)$ and  $\lrn(G-S)= O(n^{\texp}\log^{5/4-5/12} n)
= O(n^{\texp}\log^{5/6} n)$.  We can extend $\varphi$ to a colouring of $G$ by assigning each vertex in $S$ a distinct colour that is larger than every colour used in the colouring of $G-S$.  Thus, $\trn(G)\le |S|+\lrn(G-S) \le O(n^{\texp}\log n)$, which establishes \cref{l_d_degenerate_upper_bound}.  Note that this argument actually proves a slightly stronger result than \cref{l_d_degenerate_upper_bound}.  For $\ell\ge 4$, further improvements to the logarithmic factor in \cref{l_d_degenerate_upper_bound} can be obtained using the ``Furthermore'' clause of \cref{l_degenerate_and_degree}.


% The case $\ell=2$ resolves an open problem of \citet{karpas.neiman.ea:on}.

% \todo[inline]{Does this look better?
% \[ c n^{(\lceil\ell/2\rceil-1/2)/(\lceil\ell/2\rceil+1/2)}\log n \]
% % \[ c \exp\left((\lceil\ell/2\rceil-1/2)/(\lceil\ell/2\rceil+1/2)\right)\log n \]
% \[ cn^{1-\frac{1}{\lceil\ell/2\rceil+1/2}}\log n \]
% \[ cn^{1-\frac{1}{\lceil\ell/2\rceil+1/2}}\log n \]
% In text: $cn^{1-1/(\ell-1/2)}\log n$ versus $cn^{(\ell-3/2)/(\ell-1/2)}\log n$
% }

% In the next section, we prove \cref{degenerate_and_degree}.  In the subsequent section we sketch the modifications needed to prove \cref{l_degenerate_and_degree}, the $\ell$-vertex-ranking analogue of  \cref{degenerate_and_degree} and use this to establish \cref{l_d_degenerate_upper_bound}.



\section{Preliminaries}

For any standard graph-theoretic terminology and notation not defined here, we use the same conventions used in the textbook by \citet{diestel:graph}.  A graph $G$ has vertex set $V(G)$ and edge set $E(G)$.  For any $S\subseteq V(G)$, $G[S]$ denote the subgraph of $G$ induced by the vertices in $S$.  For any vertex $v$ of $G$, $N_G(v):=\{w:vw\in E(G)\}$ and $\deg_G(v):=|N_G(v)|$.  For an integer $\ell$, $G^\ell$ denotes the graph with vertex set $V(G)$ that contains an edge $vw$ if and only if some path in $G$ with at most $\ell$ edges contains $v$ and $w$.

For a directed graph $G$, we write $\overrightarrow{vw}$ to denote the directed edge with source $v$ and target $w$.  For a vertex $v$ in a directed graph $G$, $N^+_{G}(v):=\{w\in V(G):\overrightarrow{vw}\in E(G)\}$ denotes the set of out-neighbours of $v$ and $N^-_G(v):=\{u\in V(G):\overrightarrow{uv}\in E(G)\}$ denotes the set of in-neighbours of $v$, $\deg^+_{G}(v):=|N^+_G(v)|$ is the out-degree of $v$, and $\deg^-_{G}(v):=|N^-_G(v)|$ is the in-degree of $v$. We also define $N^+_{G}[v]:=\{v\}\cup N^+_{G}(v)$ and $N^-_{G}[v]:=\{v\}\cup N^-_{G}(v)$ to be the closed out- and in-neighbourhoods of $v$, respectively.

% \begin{proof}[Proof of \cref{degenerate_and_degree}]
%   Let $G$ be an $n$-vertex $d$-degenerate graph of maximum-degree $\Delta$.  Let $S_0:=V(G)$ and, for each integer $i\ge 1$, let $S_i:=\{v\in S_{i-1}:\deg_{G[S_{i-1}]}(v)\ge 4d\}$.  Since $G$ is $d$-degenerate $G[S_{i-1}]$ has at most $d|S_{i-1}|$ edges.  Therefore $2d|S_{i-1}|\ge \sum_{v\in S_{i-1}} \deg_{G[S_{i-1}]}(v)\ge 4d|S_i|$, so $|S_i|\le |S_{i-1}|/2\le n/2^i$ for each $i\ge 1$.  Let $q$ be the maximum integer such that $S_i$ is non-empty.  Since $1\le |S_q|\le n/2^q$, $q\le \log_2 n$.  For each $i\in\{0,\ldots,q\}$, let $L_i:=S_i\setminus S_{i+1}$.  (These notations are mnemonics: $S_i$ are the \defin{survivors} of round $i-1$ and $L_i$ is \defin{layer} $i$.)
%
%   Let $a:=3/2$ and $b:=1/2$.  We compute our colouring using a two phase algorithm. In the first phase we use a sequence of pairwise-disjoint color palettes $\Phi_0,\ldots,\Phi_{q}$, each of size $2k:=2d^{a}\sqrt{\Delta}\log^{b}n$, such that for each $1\le i < j\le k$, every colour in $\Phi_i$ is less than every colour in $\Phi_j$.  We will use the colours in $\Phi_i$ to colour the vertices in $L_i$, for each $i\in\{0,\ldots,q\}$.  The total number of colours used in this phase is $2k(q+1)\le 2k(1+\log n)= O(k\log n)$.
%
%   We say that a vertex $y$ of $G$ is \defin{problematic} if $y$ has a neighbour in $G$ that receives the same colour as $y$ in the first phase or if $G$ contains a path $vyw$ such that $y\in L_i$, $u,w\in L_j$, $i \le j$ and $u$ and $w$ receive the same colour in the first phase. Note that any violation of the unique-superior colouring conditions is either an edge $yw$ with $\varphi(y)=\varphi(w)$ or a path $uyw$ with $\varphi(u)=\varphi(w)>\varphi(y)$.  In either case, the vertex $y$ is problematic and this violation could be fixed by recolouring $y$ with a sufficiently large colour, which is what the second phase of the algorithm does.
%
%   For each $i\in\{0,\ldots,q\}$, fix an arbitrary total order $<_i$ on the vertices of $L_i$. Define the total order $<$ on $V(G)$ in which $v <w$ if $v\in L_i$, $w\in L_j$, and $i<j$ or if $v,w\in L_i$ and $v<_iw$. Let $H$ be the directed acyclic graph obtained from $G^2$ by directing each edge $vw$ as $\overrightarrow{vw}$ so that $v<w$.  In the discussion that follows, we will use the directed graph notations $N^+_G(v)$ and $\deg^+_G(v)$.  When we do so, we are referring to the directed acyclic graph obtained by orienting each edge $vw$ of $G$ as $\overrightarrow{vw}$ so that $v<w$.
%
%   First we observe that $\deg^+_G(v)< 4d$ for any vertex $v$ of $G$. Indeed, a vertex $v$ is contained in $L_i$ precisely because $\deg_{G[S_i]}(v)<4d$.  The bound on $\deg^+_G(v)$ then follows from the fact that $N^+_{G}(v)\subseteq N_{G[S_i]}(v)$.  Next we claim that for each vertex $v$ of $G$, $\deg^+_{H}(v)\le (4d-1)(2\Delta+1)$.  To see this, suppose $v\in L_i$ and consider some edge $\overrightarrow{vw}$ of $H$.  Then  $\overrightarrow{vw}$ is of one of the following types:
%   \begin{compactenum}[(T1)]
%     \item $vw\in E(G)$ and $v<w$. Edges of this type contribute at most $\deg^+_{G}(v)\le 4d-1$ to $\deg^+_{H}(v)$.
%     \item $G$ contains a path $vyw$ with $y < v < w$ or $v < y < w$.  Since $\deg_G(v)\le\Delta$, there are at most $\Delta$ choices for $y$.  For each such $y$, $w\in N^+_G(y)$ (since $y<w$), so there are at most $4d-1$ choices for $w$.  Therefore, edges of this type contribute at most $(4d-1)\Delta$ to the out-degree of $v$.
%     \item $G$ contains a path $vyw$ with $v < w < y$.  Since $v<y$, $y\in N_G^+(v)$, so there are at most $4d-1$ choices for $y$ and for each such $y$, $\deg_G(y)\le\Delta$, so there are at most $\Delta$ choices for $w$.  Therefore, edges of this type contribute at most $(4d-1)\Delta$ to the out-degree of $v$.
%   \end{compactenum}
%   In the first phase of colouring, we colour the vertices of $G$ in the order given by $<$.  Immediately before colouring some vertex $w\in L_i$ we count, for each colour $\alpha\in \Phi_i$, the number $N_\alpha(w)$ of neighbours $y\in N^-_G(w)$ such that $y$ has colour $\alpha$ or $y$ already has a neighbour $u$ of colour $\alpha$. Observe that $\sum_{\alpha\in \Phi_i} N_\alpha(w)\le 4d|N^-_G(w)|< 4d\Delta$ since there are at most $|N^-_G(w)|\le\Delta$ choices for $y$ and for each $y$ there are at most $4d-1$ choices for $u$.  (Since any $u$ coloured with $\alpha\in\Phi_i$ must be in $S_i$, the number of such $u$ is at most $|N_G(y)\cap S_i|\le 4d$, since $y < w$ and $w\in S_i$.)
%
%   We choose the colour of $w$ uniformly at random from a subpalette of $\Phi_i$ that contains exactly half the colours in $\Phi_i$.  Specifically we choose from a palette $\Phi_w\subset \Phi_i$ that contains the $k$ colours $\alpha$ in $\Phi_i$ with the smallest $N_\alpha(w)$ values, so that  $\max\{N_\alpha(w):\alpha\in \Phi_w\}\le\min\{N_\alpha(w):\alpha\in\Phi_i\setminus\Phi_w\}$.  Let $M:=4d\Delta/k$.  Then
%   \[
%     Mk = 4d\Delta \ge 4d|N^-_G(w)| \ge \sum_{\alpha\in \Phi_i} N_\alpha(w) \ge \sum_{\alpha\in\Phi_i\setminus\Phi_w}N_\alpha(w) \ge k\max\{N_\alpha(w):\alpha\in \Phi_w\} \enspace ,
%   \]
%   so that $\max\{N_\alpha(w):\alpha\in \Phi_w\}\le M$.  This completes the description of the first-phase colouring $\varphi$ of $G$.
%
%   At this point, we can offer some justification for the definition of the colour set $\Phi_w$ that we choose from when colouring $w$. For each problematic vertex $y$, there exists a minimum vertex $w$ (with respect to $<$) such that $y$ becomes problematic precisely when $w$ is coloured.  When this happens, we say that $w$ \defin{completes} $y$. By definition, if $w$ chooses the colour $\alpha\in\Phi_w$, then it completes at most $N_{\alpha}(w)+1\le M$ vertices.  (The additional ${}+1$ here comes from the fact that $w$ can complete itself, which occurs when $w$ chooses the same colour as one of its neighbours.) Thus, $M$ is an upper bound on the number of problematic vertices that can be created by colouring any single vertex $w$.
%
%   Let $P$ be the set of all problematic vertices in $G$.  In the second phase, we re-colour every vertex in $P$ with a colour in a palette $\Phi_{q+1}$ of size $ck\log n + 1$ whose colours are all larger than all colours in $\Phi_0,\ldots,\Phi_q$.  Since we are recolouring vertices in $P$ with large colours in $\Phi_{q+1}$, any violations of the unique-superior colouring conditions after the second phase must be caused by paths (with two or three vertices) whose endpoints are in $P$ and that receive the same colour.  In order to avoid these we will properly colour $G^2[P]$.  To show that this is possible, we will prove that, with positive probability, after the first phase, the maximum out-degree of any vertex in $H[P]$ is at most $ck\log n$.  Therefore there is some assignment of colours in phase one in which the maximum out-degree of $H[P]$ is at most $ck\log n$.  Therefore $H[P]$ is an acyclic orientation of $G^2[P]$ with maximum out-degree $ck\log n$, so $G^2[P]$ is $(ck\log n)$-degenerate.  Therefore, the $ck\log n + 1$ colours in $\Phi_{q+1}$ are sufficient to properly colour $G^2[P]$.
%
%   We now focus on an arbitrary vertex $p$ in $G$ and show that after the first phase, $|N^+_{H}(p)\cap P|\le ck\log n$ with probability $1-n^{-\Omega(c)}$.  The union bound then implies that, with probability $1-n^{-\Omega(c)}$, $|N^+_{H}[p]\cap P|\le ck\log n$ for every $p\in V(G)$.  Since $P\subseteq V(G)$, this implies that, with probability $1-n^{-\Omega(c)}$, the maximum out-degree in $H[P]$ is at most $ck\log n$.
%   % In particular, it implies that there exists a colouring of $G$ using the $O(k\log n)$ colours in $\Phi_0,\ldots,\Phi_q$ with this property.
%
%   Fix an arbitrary vertex $p$ of $G$ and suppose $p\in L_i$. We are interested in the number of problematic vertices in $N_H^+(p)$.  Let $C_p:=\bigcup_{y\in N^+_H(p)} N^+_G[y]$, which is the set of all vertices $w$ that could complete some vertex $y\in N^+_H(p)$. For each $w\in C_p$, let
%   $C_{p,w}:=N_H^+(p)\cap N_G^-[w]$, which is the set of vertices in $N^+_{H}(p)$ that $w$ could potentially complete. For each $w\in C_p$, let $\comp(p,w):=\{y\in C_{p,w}:\text{$w$ completes $y$}\}$.  For each $\alpha\in\Phi_w$, let $\comp'_\alpha(p,w)$ contain exactly those vertices $y\in C_{p,w}$ that have colour $\alpha$ or have a neighbour of colour $\alpha$ immediately before choosing the colour of $w$.  Observe that $\comp'_\alpha(p,w)$ contains every $y\in C_{p,w}$ that would be completed by $w$ if we were to set the colour of $w$ to $\alpha$ (as well as some additional vertices that may have already been completed by vertices in $C_p$ that were coloured before $w$).
%
%   Recall that $N_\alpha(w)$ counts the number of neighbours $y$ of $w$ such that $y < w$ and $y$ has colour $\alpha$ or has a neighbour of colour $\alpha$ immediately before we choose the colour of $w$.  Therefore,  $|\comp'_\alpha(p,w)|\le N_\alpha(w)+1\le M$ for each $\alpha\in\Phi_w$.  Now let $\alpha\in\Phi_w$ be the colour that is actually chosen for $w$ and let $\comp'(p,w):=\comp'_\alpha(p,w)$.  We want to study the random variable $X'_{p,w}:=|\comp'(p,w)|\ge |\comp(p,w)|$.  Since $\alpha$ is chosen from $\Phi_w$, $X'_{p,w} \le M$.
%
%   Let $\alpha_1,\ldots,\alpha_t$ be the colours in $\Phi_w$ ordered so that,
%   \[
%     |\comp'_{\alpha_1}(p,w)|\ge|\comp'_{\alpha_2}(p,w)|\ge\cdots\ge |\comp'_{\alpha_t}(p,w)| \enspace .
%   \]
%   Immediately before colouring $w\in L_i$, each $y\in C_{p,w}$ is assigned a colour (possibly in $\Phi_i$) and has at most $4d-2$ neighbours that have already received a colour in $\Phi_i$.  Therefore, $y$ appears in
%   $\comp'_{\alpha}(p,w)$ for at most $4d-1$ values of $\alpha$, so
%   \[
%     \sum_{\alpha\in\Phi_w} |\comp'_{\alpha}(p,w)| \le 4d| C_{p,w}| \enspace .
%   \]
%   Therefore $i|\comp'_{\alpha_i}(p,w)|\le\sum_{j=1}^i|\comp'_{\alpha_j}(p,w)|\le 4d|C_{p,w}|$, so
%   \[
%     |\comp'_{\alpha_i}(p,w)|\le \frac{4d|C_{p,w}|}{i} \enspace .
%   \]
%   Therefore, regardless of any random choices made before choosing the colour of $w$ and any random choices made after choosing the colour of $w$, the random variable $X'_{p,w}$ is dominated by a random variable $X_{p,w}:=\min\{4d|C_{p,w}|/j,M\}$ where $j$ is chosen uniformly in $\{1,\ldots,k\}$.
%
%   Therefore, $|N_H^+(p)\cap P|$ is dominated by a sum $X_p:=\sum_{w\in C_p} X_{p,w}$ of independent random variables.  We would like to apply a concentration result to the random variable $X$.  For this, we need to  establish sufficiently strong properties on the individual terms $X_{p,w}$, $w\in C_p$.  Thus far, we know that $0\le X_{p,w}\le M$ for each $w\in C_p$. In the appendix, we bound the expectation and variance of each $X_{p,w}$ so that we can apply a Bernstein Inequality to prove that $\Pr(X\ge ck\log n)\le n^{-\Omega(c)}$.  Thus, the number of additional colours in $\Phi_{q+1}$ needed to recolour $P$ in the second phase is $O(k\log n)$.  Thus, In this way, the total number of colours used is $O(k\log n)$, so
%   \[
%     \trn(G) \le O(k \log n) = O(d^a\sqrt{\Delta}\log^{1+b} n) = O(d^{3/2}\sqrt{\Delta}\log^{3/2} n) \enspace . \qedhere
%   \]
% \end{proof}
%
%
% \section{Generalization to \boldmath$\ell$-Vertex-Ranking}

We repeatedly make use of the following foklore result:

\begin{obs}\label{orientation_to_degeneracy}
  If an undirected graph $G$ has an orientation in which each vertex has maximum out-degree $d$, then $G$ is $2d$-degenerate.
\end{obs}

\begin{proof}
  For any $S\subseteq V(G)$, using the same orientation shows that the induced subgraph $G[S]$ has an orientation in which each vertex is the source of at most $d$ edges.  This implies that $G[S]$ contains at most $d|S|$ edges and therefore the total degree of all vertices in $G[S]$ is at most $2d|S|$.  Therefore, for any $S\subseteq V(G)$, the induced graph $G[S]$ has a vertex of degree at most $2d$.
\end{proof}

% \subsection{Cheap Tricks}
%
% \begin{lem}\label{cairns_trick}
%   For any integers $\ell\ge 1$, $d\ge 1$, $\Delta\ge d$, and any $d$-degenerate graph $G$ of maximum degree at most $\Delta$, the graph $G^{\ell}$ is $2^{\ell+2} d^{\lceil\ell/2\rceil}\Delta^{\lfloor\ell/2\rfloor}$-degenerate.
% \end{lem}
%
% \begin{proof}
%   Let $<$ be a $d$-degenerate ordering of $V(G)$, so that each vertex has at most $d$ neighbours that precede it in the order.  For each edge $vw$ of $G^{\ell}$, select some path $\Pi_{vw}:=x_0,\ldots,x_r$ in $G$ with endpoints $x_0:=v$ and $x_r:=w$ and having $r\le\ell$ edges.  Say that an edge $x_ix_{i+1}$ of $\Pi_{vw}$ is a \defin{downstream} edge of $\Pi_{vw}$ if $x_i < x_{i+1}$, otherwise it is an \defin{upstream} edge.  Consider the following orientation of $G^\ell$.  For each edge $vw$ of $G^\ell$, if at least half the edges of $\Pi_{vw}$ are downstream edges of $\Pi_{vw}$ then orient the edge $vw$ as $\overrightarrow{vw}$, otherwise orient it as $\overleftarrow{vw}$.
%
%   We claim that the resulting orientation of $G^{\ell}$ has maximum out-degree at most $2^{\ell+1} d^{\lceil\ell/2\rceil}\Delta^{\lfloor\ell/2\rfloor}$.  To see this, consider a vertex $v$ and some edge $\overrightarrow{vw}$ that contributes to the out-degree of $v$.  Suppose that $\Pi_{vw}:=x_0,\ldots,x_r$ has length $r\in\{1,\ldots,\ell\}$. Given $v$, we can uniquely identify $\Pi_{vw}$ (and hence $w$) from the following description: We first specify a sequence of $r$ bits that describes which edges of $\Pi_{vw}$ are upstream and which are downstream.  Next, we specify $x_1,\ldots,x_r$.  We know that $x_0=v$. Given $x_i$ for some $i\in\{0,\ldots,r-1\}$, if $x_ix_{i+1}$ is a downstream edge then there are at most $d$ options for $x_{i+1}$.  If $x_ix_{i+1}$ is an upstream edge then there are at most $\Delta$ options for $x_{i+1}$.  For a given $r$, the number of such paths is therefore at most $2^rd^{\lceil r/2\rceil}\Delta^{\lfloor r/2\rfloor}$, since at least half the edges of $\Pi_{vw}$ are downstream edges.  Summing over $r$ from $1$ to $\ell$ establishes the claim.  Therefore $G^{\ell}$ has an orientation in which each vertex has maximum out-degree $2^{\ell+1} d^{\lceil\ell/2\rceil}\Delta^{\lfloor\ell/2\rfloor}$.  By \cref{orientation_to_degeneracy}, $G^\ell$ is $2^{\ell+2} d^{\lceil\ell/2\rceil}\Delta^{\lfloor\ell/2\rfloor}$-degenerate.
% \end{proof}
%
% \begin{thm}\label{l_degenerate}
%   For any integers $d\ge 2$ and $\ell\ge 2$ there exists a constant $c:=c(d,\ell)$ such that, for all integers $n\ge \Delta$, every $n$-vertex $d$-degenerate graph $G$ has $\lrn(G)\le cn^{\ell/(\ell+2)}$.
% \end{thm}
%
% \begin{proof}
%   (Note that we may treat $d$ and $\ell$ as fixed, so that $n$ is only value that tends to infinity.)
%   Let $\Delta:=n^{1/\lfloor 3\ell/2\rfloor}$ and let $S:=\{v\in V(G):\deg_G(v)\ge\Delta\}$.  Then $G-S$ is $d$-degenerate and has maximum-degree $\Delta$ so, by \cref{cairns_trick}, $(G-S)^{\ell}$ is $O(\Delta^{\lfloor\ell/2\rfloor})$-degenerate and therefore has a proper colouring using $O(\Delta^{\lfloor\ell/2\rfloor})=O(n^{\lfloor\ell/2\rfloor/\lfloor 3\ell/2\rfloor)})=O(n^{1-1/\lfloor 3\ell/2\rfloor})$ colours.  This extends to an $\ell$-vertex-ranking of $G$ by giving each vertex in $S$ a distinct colour that is larger than all vertices of $G-S$.  This requires an additional $|S|=O(n/\Delta)=n^{1-1/\lfloor 3\ell/2\rfloor})$ colours.
%
%   To see that the resulting colouring is an $\ell$-vertex-ranking, consider some path $\Pi=x_0,\ldots,x_r$ in $G$ of length $r\le\ell$.  If $\Pi$ includes a vertex in $S$ then $\max\{\varphi(x):x\in S\cap \{x_0,\ldots,x_r\}\}$ is the largest colour is the unique maximum colour that appears in $\Pi$.  Otherwise, $\Pi$ is a path in $(G-S)^{\ell}$, in which case $\varphi(x_0)\neq\varphi(x_r)$.
% \end{proof}

% \subsection{Generalizing \cref{degenerate_and_degree}}

An \defin{undirected path} $\Pi$ in a graph $G$ is a connected subgraph of $G$ with exactly two vertices of degree $1$ and all other vertices of degree $2$.  The \defin{length} of $\Pi$ is the number of edges in $\Pi$, which is exactly one less than the number of vertices.  With a slight abuse of notation, we will write $x_0,\ldots,x_r$ to denote a length-$r$ undirected path $\Pi$ where $x_0$ and $x_r$ are the degree-$1$ vertices of $\Pi$ and $\Pi$ contains the edge $x_{i-1}x_i$ for each $i\in\{1,\ldots,r\}$. We call $x_0$ and $x_r$ the \defin{endpoints} of $\Pi$.

For a graph $G$, let $\mathcal{P}_\ell(G)$ denote the set of all undirected paths of length at most $\ell$ in $G$.  The set $\mathcal{P}_\ell(G)$ is critical for us, since this is precisely the set of paths that need to be considered to determine if a vertex-colouring $\varphi$ of $G$ is an $\ell$-vertex-ranking.  The following lemma shows that the paths in $\mathcal{P}_\ell(G)$ can be mapped onto their endpoints in such a way that no endpoint receives too many paths.  Its proof uses a technique introduced by Cairns \cite{?} to upper bound the number of length-$\ell$ paths in planar graphs (see also \cite[Lemma~5]{devroye.dujmovic.ea:notes}).

\todo[inline]{When I learned this trick from Bruce (Rio, 2017) he attributed it to Cairns. Do we have a reference?}



\begin{lem}\label{advanced_cairns}
  For any integers $d\ge 2$, $\ell\ge 2$, $\Delta\ge d$ and any
  graph $G$ of maximum-degree $\Delta$ that has an orientation of maximum out-degree $d$ there exists a mapping $\rho:\mathcal{P}_\ell(G)\to V(G)$ such that
  \begin{compactenum}[(i)]
    \item $\rho(P)$ is an endpoint of $P$ for each $P\in\mathcal{P}_\ell(G)$; and
    \item $|\rho^{-1}(v)| \le 2^{\ell+1}d^{\lceil \ell/2\rceil}\Delta^{\lfloor\ell/2\rfloor}$ for each $v\in V(G)$.
  \end{compactenum}
\end{lem}

\begin{proof}
  Consider some path $\Pi:=x_0,\ldots,x_r$ in $G$ of length $r\le\ell$.  Say that an edge $x_ix_{i+1}$ of $\Pi$ is a \defin{downstream} edge of $\Pi$ if it is oriented away from $x_i$, otherwise it is an \defin{upstream} edge.  If at least half the edges of $\Pi$ are downstream edges of $\Pi_{vw}$ then set $\rho(\Pi):=x_0$, otherwise set $\rho(\Pi):=x_r$.

  Observe that for any path $\Pi:=x_0,\ldots,x_r\in \rho^{-1}(x_0)$ can be uniquely reconstructed from the following information:
  \begin{compactenum}[(a)]
    \item A sequence $b_1,\ldots,b_r$ of $r$ bits, where $b_i=1$ if $x_{i-1}x_i$ is a downstream edge of $\Pi$ and $b_i=0$ if $x_{i-1}x_i$ is an upstream edge of $\Pi$.\label{bitstring}
    \item A sequence $\delta_1,\ldots,\delta_r$ of integers, where $\delta_i\in\{1,\ldots,d\}$ if $b_i=1$ and $\delta_i\in\{1,\ldots,\Delta\}$ if $b_i=0$.  The integer $\delta_i$ uniquely identifies the neighbour $x_i$ of $x_{i-1}$ so that, starting at $x_0$ we can uniquely reconstruct $\Pi$.\label{directions}
  \end{compactenum}
  The number of choices for (\ref{bitstring}) is $2^r$ and for any (\ref{bitstring}) with at least as many $1$-bits as $0$-bits, the number of choices for (\ref{directions}) is at most $d^{\lceil r/2\rceil}\Delta^{\lfloor r/2\rfloor}$.  So the number of paths of length $r$ in $\rho^{-1}(x_0)$ is at most $2^rd^{\lceil r/2\rceil}\Delta^{\lfloor r/2\rfloor}$.  Summing $r$ over $1$ to $\ell$ completes the proof.
\end{proof}

Observe that, for each edge $vw$ in $G^{\ell}$ there is at least one path in $\mathcal{P}_\ell(G)$ with endpoints $v$ and $w$.  For each edge $vw$ of $G^{\ell}$ we can select one such representative path $\Pi_{vw}\in\mathcal{P}_\ell(G)$.  If we then orient each edge $vw$ of $G^{\ell}$ away from $\rho(\Pi_{vw})$ then we get an orientation of $G^{\ell}$ in which each vertex has out-degree at most $2^{\ell+1}d^{\lceil \ell/2\rceil}\Delta^{\lfloor\ell/2\rfloor}$.  Combined with \cref{orientation_to_degeneracy} this gives the following corollary:

\begin{cor}\label{degeneracy_of_g_l}
  For any integers $d\ge 1$ and $\Delta\ge d$ and any $d$-degenerate graph $G$ of maximum degree $\Delta$, $G^{\ell}$ is $2^{\ell+2}d^{\lceil \ell/2\rceil}\Delta^{\lfloor\ell/2\rfloor}$-degenerate.
\end{cor}

In order to obtain the bound in \cref{l_degenerate_and_degree} we need a special version of \cref{advanced_cairns} that only considers paths in $\mathcal{P}_\ell(G)$ that begin with an upstream step no matter how we traverse them.  For a directed graph $G'$ whose underlying undirected graph is $G$, let $\widehat{\mathcal{P}}_\ell(G')$ denote the set of undirected paths $x_0,\ldots,x_r$ in $G$ of length $r\le\ell$ and such that $\overleftarrow{x_0x_1}$ is an edge of $G'$ and $\overrightarrow{x_{r-1}x_{r}}$ is also an edge of $G'$.

\begin{lem}\label{advanced_cairns2}
  For any integers $d\ge 2$, $\ell\ge 3$, $\Delta\ge d$ and any
  directed graph $G'$ of maximum degree $\Delta$ and maximum out-degree $d$, there exists a mapping $\rho:\widehat{\mathcal{P}}_\ell(G')\to V(G')$ such that
  \begin{compactenum}[(i)]
    \item $\rho(\Pi)\in V(\Pi)$ for each $P\in\mathcal{P}$; and
    \item $|\rho^{-1}(v)| \le 2^{\ell}d^{\lceil \ell/2\rceil+1}\Delta^{\lfloor\ell/2\rfloor-1}$ for each $v\in V(G')$.
  \end{compactenum}
\end{lem}

\begin{proof}
  The proof is almost identical to \cref{advanced_cairns2} with two modifications.  If $G'$ contains both edges $\overrightarrow{vw}$ and $\overrightarrow{wv}$ then this edge is considered as a downstream edge no matter which direction it is traversed, since there are at most $d$ options for edges leaving $v$ (one of which is $w$) and at most $d$ options for edges leaving $w$ (one of which is $v$).  The second change is that, by assigning each path $\Pi:=x_0,\ldots,x_r$ to one of $x_1$ or $x_{r-1}$ the number of options for describing $\Pi$ decreases.  Specifically, $\Pi$ can be described by a path of length $1$ with one downstream edge (for which there are $d$ options) and a path of length $r-1$ with at most $\lfloor (r-1)/2\rfloor$ upstream edges (for which there are $2^{r-1}d^{\lceil (r-1)/2\rceil}\Delta^{\lfloor(r-1)/2\rfloor}$ options).  Thus, the number of paths assigned to any vertex is at most $2^{r-1}d^{\lceil r/2\rceil+1}\Delta^{\lfloor r/2\rfloor-1}$ for $r\ge 3$ (and at most $d^r$ for $r\in\{1,2\}$).
\end{proof}


\section{The Proof}

For a vertex colouring $\varphi:V(G)\to\N$ of a graph $G$, we say that an undirected path $\Pi:=x_0,\ldots,x_r$ in $G$ is an \defin{$\ell$-violation} of $\varphi$ if $\Pi$ has length $r\le\ell$ and $\varphi(x_0)=\varphi(x_r)=\max\{\varphi(x_0),\ldots,\varphi(x_r)\}$.  Observe that $\varphi$ is an $\ell$-vertex-ranking if and only if $G$ contains no $\ell$-violations of $\varphi$.

% \begin{thm}\label{l_degenerate_and_degree}
%   For any integers $d\ge 2$ and $\ell\ge 2$ there exists a constant $c:=c(d,\ell)$ such that, for all integers $\Delta\ge d$ and $n\ge \Delta$, every $n$-vertex $d$-degenerate graph $G$ of maximum degree $\Delta$ has $\lrn(G)\le c\Delta^{\lfloor\ell/2\rfloor-1/2}\log^{1+b} n$.
% \end{thm}

\begin{proof}[Proof of \cref{l_degenerate_and_degree}]
  Let $G$ be an $n$-vertex $d$-degenerate graph of maximum-degree $\Delta$.  Let $S_0:=V(G)$ and, for each integer $i\ge 1$, let $S_i:=\{v\in S_{i-1}:\deg_{G[S_{i-1}]}(v)\ge 4d\}$.  Since $G$ is $d$-degenerate $G[S_{i-1}]$ has at most $d|S_{i-1}|$ edges.  Therefore
  \[
    2d|S_{i-1}|\ge \sum_{v\in S_{i-1}} \deg_{G[S_{i-1}]}(v)\ge 4d|S_i| \enspace ,
  \]
  so $|S_i|\le |S_{i-1}|/2\le n/2^i$ for each $i\ge 1$.  Let $q$ be the maximum integer such that $S_i$ is non-empty.  Since $1\le |S_q|\le n/2^q$, $q\le \log_2 n$.  For each $i\in\{0,\ldots,q\}$, let $L_i:=S_i\setminus S_{i+1}$.  (These notations are mnemonics: $S_i$ are the \defin{survivors} of round $i-1$ and $L_i$ is \defin{layer} $i$.)

  Let $k:=\Delta^{\lfloor\ell/2\rfloor-1/2}\log^b n$, so that our goal is to find an $\ell$-vertex-ranking of $G$ using $O(k\log n)$ colours. We compute our colouring using a two phase algorithm. In the first phase we use a sequence of pairwise-disjoint color palettes $\Phi_0,\ldots,\Phi_{q}$, each of size $2k$, such that for each $1\le i < j\le q$, every colour in $\Phi_i$ is less than every colour in $\Phi_j$.  We will use the colours in $\Phi_i$ to colour the vertices in $L_i$, for each $i\in\{0,\ldots,q\}$.  The total number of colours used in this phase is $2k(q+1)\le 2k(1+\log n)= O(k\log n)$.  The first phase colouring $\varphi:V(G)\to\Phi_0\cup\cdots\cup\Phi_q$ will have some $\ell$-violations which will be eliminated by re-colouring some vertices in the second phase using an additional palette $\Phi_{q+1}$ of size $O(k\log n)$.

  Let $\mathcal{P}$ contain all the undirected paths $x_0,\ldots,x_r$ in $\mathcal{P}_{\ell}(G)$ such that $x_0$ and $x_r$ are in the same layer $L_j$ and $\{x_1,\ldots,x_{r-1}\}\subseteq \bigcup_{i=0}^j L_i$.  Let $\rho:\mathcal{P}\to V(G)$ be the mapping given by \cref{advanced_cairns}, applied to $G$, restricted to the paths in $\mathcal{P}$. (The purpose of the restriction is so that $\rho^{-1}(v)$ denotes a subset of $\mathcal{P}$.)  We will say that a path $\Pi:=x_0,\ldots,x_r$ in $\mathcal{P}$ is \defin{problematic} if $x_0$ and $x_r$ are assigned the same colour in the first phase of the algorithm.

  Although we have not yet completed the description of the first phase colouring procedure, we already know enough to establish the following claim:  Any $\ell$-violation $\Pi$ of the first phase colouring $\varphi$ is a problematic path in $\mathcal{P}$.  Indeed, if $\Pi=x_0,\ldots,x_r$ is an $\ell$-violation, then $\varphi(x_0)=\varphi(x_r)\in \Phi_j$ for some $j\in\{0,\ldots,q\}$.  Thus $x_0,x_r\in L_j$ for some $j\in\{0,\ldots,q\}$.  Furthermore, since $\Pi$ is $\ell$-violation $\varphi(x_0)=\max\{\varphi(x_0),\ldots,\varphi(x_r)\}$, so no colour in $\Phi_{j+1},\ldots,\Phi_q$ appears at any vertex in $x_1,\ldots,x_{r-1}$.  Therefore, $\{x_1,\ldots,x_{r-1}\}\subseteq \bigcup_{i=0}^j L_i$.  Therefore $\Pi\in\mathcal{P}$.  Since $\varphi(x_0)=\varphi(x_r)$, $\Pi$ is problematic.

  We now describe the first phase colouring algorithm.  Consider the multigraph $G^*$ that, for each $vw\in V(G)$ contains as many copies of the edge $vw$ as there are undirected paths in $\mathcal{P}$ with endpoints $v$ and $w$.  The existence of $\rho$ implies that $G^*$ has an orientation in which each edge has out-degree $O(\Delta^{\lfloor\ell /2})$.  By \cref{orientation_to_degeneracy}, $G^*$ is $O(\Delta^{\lfloor\ell /2})$-degenerate.  Label the vertices of $G$ as $v_1,\ldots,v_n$ so that $v_i$ has degree $O(\Delta^{\lfloor\ell /2})$ in $G^*[\{v_1,\ldots,v_{i}\}]$. In other words, for each $a\in\{1,\ldots,n\}$ the number of paths in $\mathcal{P}$ with one endpoint at $v_a$ and the other endpoint in $\{v_1,\ldots,v_{a-1}\}$ is $O(\Delta^{\lfloor\ell /2})$.  In the first phase, we will colour the vertices one by one in the order $v_1,\ldots,v_n$.

  Let $\tau:\mathcal{P}\to V(G)$ be the mapping that maps $\Pi\in\mathcal{P}$ to $v_b$ if and only if the endpoints of $\Pi$ are $v_a$ and $v_b$ and $a < b$.\footnote{The two mappings $\tau$ and $\rho$ are similar. The difference is that $\rho$ corresponds to some orientation of $G^*$ and $\tau$ corresponds to an acyclic orientation of $G^*$.}  Consider some vertex $w\in L_j$.  For each $\alpha \in \Phi_j$, let $N_{\alpha}(w)$ be the number of paths in $\tau^{-1}(w)$ whose other endpoint (not $w$) is assigned the colour $\alpha$. If $w=v_b$ then $N_{\alpha}(w)$ is completely determined by the colours of $v_1,\ldots,v_{b-1}$, so the value of $N_\alpha(v_b)$ is determined after $v_{b-1}$ is coloured but before $v_b$ is coloured.  Observe that assigning the colour $\alpha$ to $w$ creates exactly $N_{\alpha}(w)$ problematic paths, and these are all in $\tau^{-1}(w)$.  Therefore, $\sum_{\alpha\in\Phi_i} N_\alpha(w)=|\tau^{-1}(w)|$.

  For each vertex $w$, we choose the colour of $w$ uniformly at random from a subpalette of $\Phi_i$ that contains exactly half of the $2k$ colours in $\Phi_i$.  Specifically, we choose the colour of $w$ from a palette $\Phi_w\subset \Phi_i$ that contains $k$ colours $\alpha$ in $\Phi_i$ with the smallest $N_\alpha(w)$ values, so that  $\max\{N_\alpha(w):\alpha\in \Phi_w\}\le\min\{N_\alpha(w):\alpha\in\Phi_i\setminus\Phi_w\}$.  Let $M:=c\Delta^{\lfloor\ell/2\rfloor}/k$ with $c$ sufficiently large so that $Mk\ge \tau^{-1}(w)$.
  Then
  \[
    Mk \ge |\tau^{-1}(w)|= \sum_{\alpha\in \Phi_i} N_\alpha(w) \ge \sum_{\alpha\in\Phi_i\setminus\Phi_w}N_\alpha(w) \ge k\max\{N_\alpha(w):\alpha\in \Phi_w\} \enspace .
  \]
  Therefore, $\max\{N_\alpha(w):\alpha\in \Phi_w\}\le M$ is the maximum number of problematic paths in $\mathcal{P}$ that can be created by colouring any single vertex.  This completes the description of the first-phase colouring $\varphi$ of $G$.


  The first phase colouring $\varphi$ is not yet an $\ell$-vertex-ranking.  Our goal now is to study the $\ell$-violations of $\varphi$.  For each $\ell$-violation $\Pi$, we will choose a vertex $y$ of $\Pi$ to recolour in the second round, in order to eliminate this $\ell$-violation.  Consider the directed graph $G'$ obtained from $G$ by adding each edge $\overrightarrow{vw}$ if $vw\in E(G)$, $v\in L_i$, $w\in L_j$ and $i\le j$.  (Note that if $v$ and $w$ are in the same layer $L_j$ then both edges $\overrightarrow{vw}$ and $\overleftarrow{vw}$ are present in $G'$.)  Then $G'$ has maximum out-degree $4d$ and $\widehat{\mathcal{P}}_\ell(G')$ contains $\mathcal{P}$. Let $\gamma:\mathcal{P}\to V(G)$ be the result of applying \cref{advanced_cairns2} to $G'$ (and then restricting it to the paths in $\mathcal{P}$.)

  Consider a problematic path $\Pi:=x_0,\ldots,x_r$ and suppose, without loss of generality that $\tau(\Pi)=x_0$.  Then $x_r$ was coloured before $x_0$ and $\Pi$ became problematic precisely when $x_0$ was coloured.
  % When this happens we say that $x_0$ \defin{completes} $\Pi$.
  By the time the colouring is complete, a problematic path $\Pi$ may be an $\ell$-violation.  In order to eliminate this potential $\ell$-violation we will assign a vertex $y\in V(\Pi)$ to be recoloured in the second phase.  Specifically, we declare the vertex $y:=\gamma(\Pi)$ to be \defin{problematic} and we recolour $y$ in the second phase.  We remark that not every problematic path $\Pi$ becomes an $\ell$-violation, but every $\ell$-violation is a problematic path.  Therefore every $\ell$-violation $\Pi$ contains a problematic vertex $y=\gamma(\Pi)$ that will be recoloured in the second phase.

  % So when $\Pi$ is problematic, we say that $y:=\gamma(\Pi)$ is \defin{problematic} and we say that $x_0$ \defin{completes} $y$.\todo{Do we use this term for vertices anymore?} Note that a vertex $y$ may be completed more than once. Indeed, for any path $\Pi$ in $\gamma^{-1}(y)$, the vertex $\tau(\Pi)$ could complete $\Pi$ and therefore complete $y$.  Note that it is also not required that $\Pi$ be an $\ell$-violation of $\varphi$.  However, for every $\ell$-violation $\Pi$ of $\varphi$, $\Pi$ is problematic, so $\gamma(\Pi)$ is defined.

  Let $P$ be the set of all problematic vertices.
  % Since every $\ell$-violation $\Pi$ of $\varphi$ is a problematic path and every problematic path contains a problematic vertex $y:=\gamma(\Pi)$, every $\ell$-violation contains at least one vertex of $P$.
  In the second phase, we recolour every vertex in $P$ with a colour in a palette $\Phi_{q+1}$ of size $ck\log n + 1$ whose colours are all larger than all colours in $\Phi_0,\ldots,\Phi_q$.  Since each $\ell$-violation of $\varphi$ contains a vertex in $P$, this recolouring eliminates all $\ell$-violations in $\varphi$.  More precisely, after this recolouring any remaining $\ell$-violation must have endpoints whose colour is in $\Phi_{q+1}$.  In order to avoid this, we will ensure that our recolouring is a proper colouring of $G^\ell[P]$.  By definition, this means that any path in $\mathcal{P}_\ell(G)$ with both endpoints in $P$ has endpoints of different colours and is therefore not an $\ell$-violation.

  By \cref{degeneracy_of_g_l}, $G^\ell$ is $O(\Delta^{\lfloor\ell /2\rfloor})$-degenerate.  Let $H$ be a directed acyclic graph obtained from $G^{\ell}$ in which each vertex has out-degree $O(\Delta^{\lfloor\ell /2\rfloor})$.
  We want to show that $G^\ell[P]$ has chromatic number at most $ck\log n+1$.  To do this, we will show that the maximum out-degree of $H[P]$ is at most $ck\log n$, with high probability.  In fact, we will show something stronger: that every vertex $p$ in $H$ has at most $ck\log n$ neighbours in $P$.

  From this point on, we fix some vertex $p$ of $H$ and study the random variable $|N_H^+(p)\cap P|$.  Instead of focusing on the set $P$ of problematic vertices, we focus instead on problematic paths.  For each problematic vertex $y$, some path $\Pi$ in $\gamma^{-1}(y)$ is problematic. Therefore,
  \begin{equation}
    |N^+_H(p)\cap P| \le \sum_{y\in N^+_H(p)} \left|\left\{\Pi\in\gamma^{-1}(y): \text{$\Pi$ is problematic}\right\}\right| =: X'_{p} \enspace .
    \label{path_upper_bound}
  \end{equation}
  Each path $\Pi\in\mathcal{P}$ is problematic with probability at most $1/k$ since this occurs precisely when we choose the same colour for $w:=\tau(\Pi)$ that was already chosen for the other endpoint of $\Pi$.  Therefore,
  \begin{align*}
    \E\left(|N^+_H(p)\cap P|\right)
    & \le \frac{1}{k}\sum_{y\in N^+_H(p)}|\gamma^{-1}(y)| \\
    & \le \frac{1}{k}\cdot|N^+_H(p)|\cdot O(\Delta^{\lfloor\ell /2\rfloor-1}) \\
    & \le \frac{1}{k}\cdot O(\Delta^{2\lfloor\ell /2\rfloor-1}) \\
    & = O(\Delta^{\lfloor\ell /2\rfloor-1/2}\log^{-b} n) = O(k) \enspace .
  \end{align*}
  This is a good sign. If the event set $\{\text{``$\Pi$ is problematic''}:\Pi\in\mathcal{P}\}$ were mutually independent then it would be a simple matter of applying a Chernoff bound.  Unfortunately this is not the case since, for each vertex $w$, the events $\{\text{``$\Pi$ is problematic''}:\Pi\in\tau^{-1}(w)\}$ are all affected by the choice of colour for $w$.

  The remainder of the proof is more probability than graph theory.  We will use a tail estimate for sums of independent random variables due to Bernstein that is applicable when these random variables have sufficiently small variance.  The statement of Bernsten's Inequality and the calculations needed to apply it in this context are deferred to the appendix. We use the rest of our time here to describe a random variable $X_p$ that stochastically dominates $|N^+_H(p)\cap P|$ and is a sum of independent random variables.\footnote{A random variable $X$ stochastically dominates a random variable $Y$ if $\Pr(Y\ge x) \le \Pr(X\ge x)$ for all $x\in\R$.}

  For each vertex $w$ of $G$, let $\mathcal{P}_{p,w}:=\tau^{-1}(w)\cap (\bigcup_{y\in N^+_H(p)}\gamma^{-1}(y))$ and define
  \[
    X'_{p,w} :=\left|\left\{\Pi\in\mathcal{P}_{p,w}:\text{$\Pi$ is problematic}\right\}\right|
    \enspace .
  \]
  Since each problematic path $\Pi$ counted by the right-hand-side of \cref{path_upper_bound} becomes problematic when $w:=\tau(\Pi)$ is coloured, $X'_p=\sum_{w\in V(G)} X'_{p,w}$.

  For each $\alpha\in\Phi_i$, let $N_\alpha(p,w)$ be the number of paths in $\mathcal{P}_{p,w}$ that would have become problematic if we had set the colour of $w$ to $\alpha$. If $w\in L_j$ then $\sum_{\alpha\in\Phi_w} N_\alpha(p,w) \le \sum_{\alpha\in\Phi_j} N_\alpha(p,w) \le \sum_{\alpha\in\Phi_j} N_\alpha(w) = |\tau^{-1}(w)|$.

  Let $\alpha_1,\ldots,\alpha_k$ be the colours in $\Phi_w$ ordered so that,
  \[
    N_{\alpha_1}(p,w) \ge N_{\alpha_2}(p,w) \ge\cdots\ge N_{\alpha_k}(p,w) \enspace .
  \]
  Then, for each $i\in\{1,\ldots,k\}$, $iN_{\alpha_i}(p,w)\le\sum_{j=1}^i N_{\alpha_j}(p,w) \le |\tau^{-1}(w)|$, so
  \[
    N_{\alpha_i}(p,w)\le \frac{|\tau^{-1}(w)|}{i}=\frac{O(\Delta^{\lfloor\ell/2\rfloor})}{i} \enspace .
  \]
  Therefore, regardless of any random choices made before choosing the colour of $w$ and any random choices made after choosing the colour of $w$, the random variable $X'_{p,w}$ is dominated by a random variable $X_{p,w}:=\min\{O(\Delta^{\lfloor\ell/2\rfloor})/i,M\}$ where $i$ is chosen uniformly in $\{1,\ldots,k\}$.

  Therefore, $|N_H^+(p)\cap P|$ is dominated by a sum $X_p:=\sum_{w} X_{p,w}$ of independent random variables.  In order to apply a concentration result to the random variable $X_p$, we need to  establish sufficiently strong properties on the individual terms $X_{p,w}$.  Thus far, we know that $0\le X_{p,w}\le M$ for all $w$, which is a good starting point, but not enough.  In the appendix, we bound the expectation and variance of each $X_{p,w}$ so that we can apply Bernstein's Inequality to prove that $\Pr(X\ge ck\log n)\le n^{-\Omega(c)}$.  Thus, the number of additional colours in $\Phi_{q+1}$ needed to recolour the vertices of $P$ in the second phase is $O(k\log n)$.  Since the total number of colours used in the first phase is $O(k\log n)$, we have
  \[
    \lrn(G) = O(k \log n) = O(\Delta^{\lfloor\ell/2\rfloor+1/2}\log^{1+b} n) \enspace . \qedhere
  \]
\end{proof}
%
% Unfortunately, \cref{l_degenerate_and_degree} is not strong enough to improve \cref{l_degenerate} for $\ell\ge 3$.  Indeed, using \cref{l_degenerate_and_degree} and the usual trick of colouring high-degree vertices with distinct colours only gives  $\trn(G)\le O(n^{(\ell-3/2)/(\ell-1/2)})$, which is worse than the bound in \cref{l_degenerate} for all $\ell\ge 3$.



\bibliographystyle{plainnat}
\bibliography{us2}

\appendix

\section{Bounding the Tail of \boldmath$|N_H^+(v)|$}

We make use of the following inequality of Bernstein \cite[Corollary~2.11]{boucheron.lugosi.ea:concentration}:

\begin{thm}\label{bernstein_theorem}
  Let $M$ be a positive number, let $X_1,\ldots,X_r$ be independent random variables such that $0\le X_i\le M$ for each $i\in\{1,\ldots,r\}$, and let $X:=\sum_{i=1}^r X_i$. Then
  \begin{equation}
    \Pr\left(X \ge \E(X)+ t\right)
      \le \exp\left(\frac{\tfrac{1}{2}t^2}{\sum_{i=1}^r \E((X_i-\E(X_i))^2)+\tfrac{1}{3}Mt}\right) \enspace . \label{bernstein}
  \end{equation}
\end{thm}
We will apply \cref{bernstein_theorem} to a random variable $X:=\sum_{i=1}^r X_i$ in which each $X_i$ has the following distribution (for some $0\le x_i\le kM$):
\[
  X_i = \begin{cases}
          M & \text{with probability $(1/k)\lfloor x_1/M\rfloor$} \\
          x_i/j & \text{with probability $1/k$ for each $j\in\{\lfloor x_i/M\rfloor+1,\ldots,k\}$}
        \end{cases}
\]
This is the distribution we get when we choose a uniform $j\in\{1,\ldots,k\}$ and set $X_i:=\min\{M,x_i/j)$.  To see how this applies in the proof of \cref{l_degenerate_and_degree}, let $\{w_1,\ldots,w_n\}:=V(G)$ and, for each $i\in\{1,\ldots,n\}$, let $x_i:=|\tau^{-1}(w_i)\cap\left(\bigcup_{y\in N^+_H(p)}\gamma^{-1}(y)\right)|$.  In our setting $k=\Delta^{\lfloor\ell/2\rfloor-1/2}\log^b n$ for some $b\ge 0$,  $M=a\Delta^{\lfloor\ell/2\rfloor}/k$ for some constant $a$, and $t=ck\log n$ for some (sufficiently large) constant $c$.  The rest of this appendix is devoted to bounding the various quantities that appear in \cref{bernstein} so that we can show that the right-hand side of \cref{bernstein} is $n^{-\Omega(c)}$.

Both the maximum value and the sum of $x_1,\ldots,x_n$ are important for us. For the maximum, we have $x_i\le|\tau^{-1}(w_i)|= O(\Delta^{\lfloor\ell/2\rfloor})$ for all $i\in\{1,\ldots,n\}$.  We have already bounded by the sum when computing the expectation of $|N_H^+(p)\cap P|$ as follows:
\[
  \sum_{i=1}^n x_i = \sum_{y\in N^+_H(p)} |\gamma^{-1}(y)|
  \le |N^+_H(p)|\cdot O(\Delta^{\lfloor\ell/2\rfloor-1})
  \le O(\Delta^{2\lfloor\ell/2\rfloor-1}) \enspace .
\]

For each $i\in\{1,\ldots,n\}$, we have
\begin{align*}
  \E(X_i)
  & =\Pr(X_i=M)\cdot M + \sum_{j=\lfloor x_i/M\rfloor+1}^k \Pr(X_i=j)\cdot\frac{x_i}{j} \\
  & \le\frac{x_i}{kM}\cdot M + \frac{1}{k}\cdot\sum_{j=\lfloor x_i/M\rfloor+1}^k \frac{x_i}{j} \\
  & \le\frac{x_i}{k} + \frac{1}{k}\cdot\sum_{j=1}^k \frac{x_i}{j} \\
  & \le \frac{x_i(2+\ln k)}{k} \\
  & = O\left(\frac{x_i\log k}{k}\right) \\
  & = O\left(\frac{x_i\log n}{k}\right)
  \enspace ,
\end{align*}
where the last line comes from the fact that $d,\Delta \le n$.
Therefore,
\begin{align*}
  (\E(X_i))^2
  & = O\left(\left(\frac{x_i\log n}{k}\right)^2\right) \\
  & = O\left(\frac{x_i^2\log^2 n}{k^2}\right) \\
  & = O\left(\frac{x_i^2\log^2 n}{\Delta^{2\lfloor\ell/2\rfloor-1}\log^{2b} n}\right) \\
  & = O\left(\frac{x_i\log^{2-2b} n}{\Delta^{\lfloor\ell/2\rfloor-1}}\right)
  & \text{(since $x_i=O(\Delta^{\lfloor\ell/2\rfloor})$)} \\
\end{align*}
Now,
\begin{equation}
  \E((X_i-\E(X_i))^2)  = \frac{1}{k}\left\lfloor\frac{x_i}{M}\right\rfloor\cdot(M-\E(X_i))^2 + \sum_{j=\lfloor x_i/M\rfloor+1}^k \frac{1}{k}\left(\frac{x_i}{j}-\E(X_i)\right)^2 \label{variance}
\end{equation}
We bound the first term in \cref{variance} as follows:
\begin{align*}
  \frac{1}{k}\left\lfloor\frac{x_i}{M}\right\rfloor\cdot(M-\E(X_i))^2
  & \le \frac{x_i}{kM}\left(M^2 + (\E(X_i))^2\right) \\
  & = \frac{M x_i}{k} + \frac{x_i}{kM}\cdot (\E(X_i))^2 \\
  & \le \frac{M x_i}{k} + (\E(X_i))^2
  & \text{(since $x_i=|\tau^{-1}(2_i)|\le Mk$)}\\
  & = O\left(\frac{\Delta^{\lfloor\ell/2\rfloor}x_i}{k^2}\right) + (\E(X_i))^2
  & \text{(by the definition of $M$)}\\
  & = O\left(\frac{x_i\log^{-2b} n}{\Delta^{\lfloor\ell/2\rfloor-1}}\right) + (\E(X_i))^2
  & \text{(by the definition of $k$)}\\
  & = O\left(\frac{x_i\log^{2-2b} n}{\Delta^{\lfloor\ell/2\rfloor-1}}\right)
  & \text{(see above, since $2-2b\ge -2b$)} \enspace .
\end{align*}
We bound the remaining terms in \cref{variance} as follows:
\begin{align*}
 \sum_{j=\lfloor x_i/M\rfloor+1}^k \frac{1}{k}\left(\frac{x_i}{j}-\E(X_i)\right)^2
  & \le \sum_{j=\lfloor x_i/M\rfloor+1}^k \frac{1}{k}\left(\frac{x_i^2}{j^2}+(\E(X_i))^2\right) \\
  & \le (\E(X_i))^2+\frac{1}{k}\sum_{j=\lfloor x_i/M\rfloor+1}^k \frac{x_i^2}{j^2} \\
  & \le (\E(X_i))^2 +  \frac{1}{k}\cdot\frac{M\pi^2x_i^2}{6 x_i}
  & \text{(since $\sum_{j=z}^{\infty} \tfrac{1}{j^2} \le \tfrac{\pi^2}{6z}$ for $z\ge 1$)} \\
  & = (\E(X_i))^2 + O\left(\frac{Mx_i}{k}\right) \\
  % & = (\E(X_i))^2 + O\left(\frac{x_i\log^{-2b} n}{\Delta^{\lfloor\ell/2\rfloor-1}}\right) & \text{(as above)} \\
  & = O\left(\frac{x_i\log^{2-2b} n}{\Delta^{\lfloor\ell/2\rfloor-1}}\right)
  & \text{(as above)} \enspace .
\end{align*}
Therefore
\[
  \E((X_i-\E(X_i))^2) = O\left(\frac{x_i\log^{2-2b} n}{\Delta^{\lfloor\ell/2\rfloor-1}}\right)
\]
for all $i\in\{1,\ldots,n\}$.  Recall that $\sum_{i=1}^n x_i = O(\Delta^{2\lfloor\ell/2\rfloor-1})$, so
\[
  \E(X)
  = \sum_{i=1}^n \E(X_i)
  = \sum_{i=1}^n O\left(\frac{x_i\log n}{k}\right)
  = O\left(\frac{\Delta^{2\lfloor\ell/2\rfloor-1}\log n}{k}\right)
  = O\left(\Delta^{\lfloor\ell/2\rfloor-1/2}\log^{1-b} n\right) \enspace .
\]
and
\[
  \sum_{i=1}^r\E((X_i-\E(X_i))^2)
  = \sum_{i=1}^r O\left(\frac{x_i\log^{2-2b} n}{\Delta^{\lfloor\ell/2\rfloor-1}}\right)
  = O\left(\frac{\Delta^{2\lfloor\ell/2\rfloor-1}\log^{2-2b} n}{\Delta^{\lfloor\ell/2\rfloor-1}}\right)
  = O\left(\Delta^{\lfloor\ell/2\rfloor}\log^{2-2b} n\right)
  \enspace .
\]
Then \cref{bernstein} gives:
\begin{align*}
  \Pr(X\ge \E(X)+t)
  & = \Pr(X\ge \E(X)+ck\log n) \\
  & \le \exp \left(-\frac{\tfrac{1}{2}(ck\log n)^2}{O\left(\Delta^{\lfloor\ell/2\rfloor}\log^{2-2b} n\right) + \tfrac{1}{3}Mck\log n}\right) \\
  & = \exp \left(-\frac{\tfrac{1}{2}(ck\log n)^2}{O\left(\Delta^{\lfloor\ell/2\rfloor}\log^{2-2b} n +c\Delta^{\lfloor\ell/2\rfloor}\log n)\right)}\right)
    & \text{(since $Mk=O(\Delta^{\lfloor\ell/2\rfloor})$)} \\
  & = \exp \left(-\frac{\tfrac{1}{2}(ck\log n)^2}{O\left(c\Delta^{\lfloor\ell/2\rfloor}\log^{2-2b} n\right)}\right) & (\text{for $c\ge 1$ and $b\le 1/2$}) \\
  & = \exp \left(-\frac{\tfrac{1}{2}c\Delta^{2\lfloor\ell/2\rfloor-1}\log^{2+2b} n}{O\left(\Delta^{\lfloor\ell/2\rfloor}\log^{2-2b} n\right)}\right) & \text{(by definition of $k$)}\\
  & = \exp\left(-\Omega(c\Delta^{\lfloor\ell/2\rfloor-1}\log^{4b} n)\right) \\
  % & = \exp\left(-\Omega(c\log^{4b} n)\right) & \text{since $\ell\ge 2$} \\
  & = n^{-\Omega(c)} \enspace ,
\end{align*}
provided that $b\ge 1/4$ or $\Delta^{\lfloor\ell/2\rfloor-1}\ge\log n$.
For any fixed $c$, taking $b=1/4$ gives
\begin{align*}
  \E(X)+t
    & = O(\Delta^{\lfloor\ell/2\rfloor-1/2}\log^{1-b} n + k\log n) \\
    & = O(\Delta^{\lfloor\ell/2\rfloor-1/2}(\log^{1-b} n + \log^{1+b} n)) \\
    & = O(\Delta^{\lfloor\ell/2\rfloor-1/2}\log^{5/4} n)
\end{align*}
Thus, $\Pr(X\ge \Delta^{\lfloor\ell/2\rfloor-1/2}\log^{5/4} n) \le n^{-\Omega(c)}$, which completes the first part of the proof of \cref{l_degenerate_and_degree} for the cases $\ell=2$ and $\ell=3$.  To complete the ``furthermore'' clause of the proof we take $b=0$ and deduce that $\E(X)+t=O(\Delta^{\lfloor\ell/2\rfloor-1/2}\log n)$.



% We finish by noting that, for $\ell\ge 4$ and $\Delta\ge\log n$, we can drop the condition $b\ge 4$ and the calculation still works because the $\Delta^{\lfloor\ell/2\rfloor-1}$ factor makes up for the $\log^{4b} n$ factor.  In particular, the proof of \cref{l_degenerate} has $\Delta

\end{document}

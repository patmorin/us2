\documentclass{patmorin}
\listfiles


\definecolor{brightmaroon}{rgb}{0.76, 0.13, 0.28}
\definecolor{linkblue}{rgb}{0, 0.337, 0.227}
\newcommand{\defin}[1]{\emph{\color{brightmaroon}#1}}
\setlength{\parskip}{1ex}

\DeclareMathOperator{\comp}{comp}

\title{\MakeUppercase{A Unique Superior is Still One Too Many}}
\author{Bra\v{c} 2023 Gang}


\newcommand{\rn}[1]{\chi_{\operatorname{#1-vr}}}
\newcommand{\irn}{\rn{\infty}}
% \newcommand{\trn}{\rn{2}}
\newcommand{\trn}{\chi_{\mathrm{us}}}
\newcommand{\lrn}{\rn{\ell}}
\newcommand{\dtcn}{\bar{\chi}_2}
\newcommand{\dlcn}{\bar{\chi}_\ell}
\newcommand{\scn}{\chi_{\star}}


% \pagenumbering{roman}
\begin{document}

\maketitle

\begin{abstract}
  A \defin{unique-superior colouring} (also known as a \defin{$2$-vertex-ranking} or \defin{restricted star colouring}) is a mapping $\varphi:V(G)\to\N$ of the vertices of a graph $G$ to integer colours so that for any edge $uv$, $\varphi(u)\neq \varphi(v)$ and for any $3$-vertex path $uvw$, $\phi(u)\neq\varphi(w)$ or $\varphi(v)>\varphi(u)$.  For a graph $G$, the \defin{unique-superior chromatic number} $\trn(G)$ is the minimum value of $k$ such that $G$ has a unique-superior colouring $\varphi:V(G)\to\{1,\ldots,k\}$.  We show that there exists a constant $c$ such that every $n$-vertex $d$-degenerate graph $G$ has $\trn(G) \le cd^{4/3}(n\log n)^{1/3}$.  This almost matches the lower bound of $\Omega(n^{1/3})$ for $2$-degenerate graphs and significantly improves the previous upper bound of $O(\sqrt{dn})$ for $d$-degenerate graphs---both given by \citet{karpas.neiman.ea:on}. These results extend to the \defin{$\ell$-vertex-ranking} problem in which one considers all paths $v_0,\ldots,v_r$ of length $r\le \ell$ and requires that $\varphi(v_0)\neq\varphi(v_r)$ or that $\varphi(v_0)<\max\{\varphi(v_1),\ldots,\varphi(v_{r-1})\}$.  In this setting, for any fixed $\ell$ and $d$, the bound on the $\ell$-vertex-ranking number $\lrn(G)$ for any $d$-degenerate graph $G$ is $O(n^{(\ell-3/2)/(\ell-1/2)}\log n)$.
\end{abstract}


% \tableofcontents
%
% \newpage
% \pagenumbering{arabic}



\section{Introduction}

A \defin{unique-superior colouring} (also known as a \defin{$2$-vertex-ranking} or \defin{restricted star colouring}) is a mapping $\varphi:V(G)\to\N$ of the vertices of a graph $G$ to integer colours so that for any edge $uv$, $\varphi(u)\neq \varphi(v)$ and for any $3$-vertex path $uvw$, $\varphi(u)\neq\varphi(w)$ or $\varphi(v)>\varphi(u)$.  For a graph $G$, the unique-superior chromatic number $\trn(G)$ is the minimum value of $k$ such that $G$ has a unique-superior colouring $\varphi:V(G)\to\{1,\ldots,k\}$.

\citet{karpas.neiman.ea:on} showed that for every $d$-degenerate\footnote{A graph $G$ is \defin{$d$-degenerate} if every non-empty subgraph of $G$ has a vertex of degree at most $d$.  Equivalently, $G$ is $d$-degenerate if it has a vertex ordering in which each vertex precedes at most $d$ of its neighbours in the ordering.} $n$-vertex graph $G$, $\trn(G)\in O(\sqrt{dn})$ and that there exists $2$-degenerate $n$-vertex graphs with $\trn(G)\in\Omega(n^{1/3})$.\footnote{In \cite[Theorem~6.2]{karpas.neiman.ea:on} the authors prove the bound $O(d\sqrt{n})$, but an easy optimization of their argument (separately colouring all vertices of degree greater than $\sqrt{n/d}$ with distinct large colours) improves this to $O(\sqrt{dn})$.}  They leave the question of closing the gap between these bounds as an open problem. In the current paper we give a colouring procedure that essentially matches their lower bound to within a polylogarithmic factor.  In particular, for fixed $d$, $\trn(G)\in O((n\log n)^{1/3})$.

\begin{thm}\label{d_degenerate_upper_bound}
  There exists a constant $c>0$ such that for any integer $d\ge 1$, every $n$-vertex $d$-degenerate graph $G$ has $\trn(G) \le c d^{4/3}(n\log n)^{1/3}$.
\end{thm}

Like the upper bound in \cite{karpas.neiman.ea:on}, \cref{d_degenerate_upper_bound} follows quickly from a theorem about graphs that are both $d$-degenerate and have maximum-degree $\Delta$. For such graphs, we prove:

\begin{thm}\label{degenerate_and_degree}
  There exists a constant $c>0$ such that
  for all integers $\Delta\ge d \ge 1$, and $n> \Delta$, every $d$-degenerate $n$-vertex graph $G$ of maximum degree at most $\Delta$ has
  $\trn(G)\leq cd^{3/2}\sqrt{\Delta}\log^{3/2} n$.
\end{thm}

\Cref{d_degenerate_upper_bound} follows easily from \cref{degenerate_and_degree}, by the following argument:  Since $G$ is $d$-degenerate, it has at most $dn$ edges and the sum of its vertex degrees is at most $2dn$.  Let $\Delta:=d^{-1/3}n^{2/3}\log^{-1/3} n$.  Then the set $S:=\{v\in V(G):\deg_G(v)\ge \Delta\}$ has size at most $2dn/\Delta=2d^{4/3}n^{1/3}\log^{1/3} n$.  Since $G-S$ has maximum degree $\Delta$, $G-S$ has a unique-superior colouring $\varphi$ using at most
\[
  cd^{3/2}\sqrt{\Delta}\log^{1/2} n
  % = c\cdot \sqrt{\frac{n^{2/3}}{d^{1/3}\log^{1/2} n}}\cdot \log^{3/4} n
  = c d^{\tfrac{3}{2}-\tfrac{1}{6}}n^{\tfrac{1}{3}}\log^{\tfrac{1}{2}-\tfrac{1}{6}} n
  = c d^{\tfrac{4}{3}}(n\log n)^{\tfrac{1}{3}}
\]
colours, by \cref{degenerate_and_degree}. We can extend $\varphi$ to a colouring of $G$ by assigning each vertex in $S$ a distinct colour that is larger than every colour used in the colouring of $G-S$.  Thus, $\trn(G)\le |S|+\trn(G-S)\le (2+c)d^{4/3}(n\log n)^{1/3}$, which establishes \cref{d_degenerate_upper_bound}.

A vertex colouring $\varphi$ of $G$ is an \defin{$\ell$-vertex-ranking} of $G$ if, for each path $v_0,\ldots,v_r$ in $G$ with $1\le r\le\ell$ edges, $\varphi(v_0)\neq \varphi(v_r)$ or $\max\{\varphi(v_1),\ldots,\varphi(v_{r-1})\}>\varphi(v_0)$.  The \defin{$\ell$-vertex-ranking} number $\lrn(G)$ is the minimum integer $k$ such that $G$ has a vertex $\ell$-ranking $\varphi:V(G)\to\{1,\ldots,k\}$.  Note that $\varphi$ is a $2$-vertex ranking of $G$ if and only if it is a unique-superior colouring of $G$, so $\trn(G)=\rn{2}(G)$ for every graph $G$.  Using the same techniques, we establish the following upper bound for the $\ell$-vertex-ranking number of $d$-degenerate graphs:

\begin{thm}\label{l_d_degenerate_upper_bound}
  For all positive integers $d$ and $\ell$ there exists a constant $c:=c(d,\ell)$ such that, for every integer $n\ge d$, every $n$-vertex $d$-degenerate graph $G$ has
  \[
    \lrn(G)\le c n^{\frac{\ell-3/2}{\ell-1/2}}\log n \enspace .
  \]
\end{thm}
\todo[inline]{Does this look better?
\[ cn^{1-\frac{1}{\ell-1/2}}\log n \]
In text: $cn^{1-1/(\ell-1/2)}\log n$ versus $cn^{(\ell-3/2)/(\ell-1/2)}\log n$
}

In the next section, we prove \cref{degenerate_and_degree}.  In the subsequent section we sketch the modifications needed to prove \cref{l_degenerate_and_degree}, the $\ell$-vertex-ranking analogue of  \cref{degenerate_and_degree} and use this to establish \cref{l_d_degenerate_upper_bound}.



\section{The Proof}

For any standard graph-theoretic terminology and notation not defined here, we use the same conventions used in the textbook by \citet{diestel:graph}.  A graph $G$ has vertex set $V(G)$ and edge set $E(G)$.  For any $S\subseteq V(G)$, $G[S]$ denote the subgraph of $G$ induced by the vertices in $S$.  For any vertex $v$ of $G$, $N_G(v):=\{w:vw\in E(G)\}$ and $\deg_G(v):=|N_G(v)|$.  For an integer $\ell$, $G^\ell$ denotes the graph with vertex set $V(G)$ that contains an edge $vw$ if and only if some path in $G$ with at most $\ell$ edges contains $v$ and $w$.

For a directed graph $G$, we write $\overrightarrow{vw}$ to denote the directed edge with source $v$ and target $w$.  For a vertex $v$ in a directed graph $G$, $N^+_{G}(v):=\{w\in V(G):\overrightarrow{vw}\in E(G)\}$ denotes the set of out-neighbours of $v$ and $N^-_G(v):=\{u\in V(G):\overrightarrow{uv}\in E(G)\}$ denotes the set of in-neighbours of $v$, $\deg^+_{G}(v):=|N^+_G(v)|$ is the out-degree of $v$, and $\deg^-_{G}(v):=|N^-_G(v)|$ is the in-degree of $v$. We also define $N^+_{G}[v]:=\{v\}\cup N^+_{G}(v)$ and $N^-_{G}[v]:=\{v\}\cup N^-_{G}(v)$ to be the closed out- and in-neighbourhoods of $v$, respectively.

\begin{proof}[Proof of \cref{degenerate_and_degree}]
  Let $G$ be an $n$-vertex $d$-degenerate graph of maximum-degree $\Delta$.  Let $S_0:=V(G)$ and, for each integer $i\ge 1$, let $S_i:=\{v\in S_{i-1}:\deg_{G[S_{i-1}]}(v)\ge 4d\}$.  Since $G$ is $d$-degenerate $G[S_{i-1}]$ has at most $d|S_{i-1}|$ edges.  Therefore $2d|S_{i-1}|\ge \sum_{v\in S_{i-1}} \deg_{G[S_{i-1}]}(v)\ge 4d|S_i|$, so $|S_i|\le |S_{i-1}|/2\le n/2^i$ for each $i\ge 1$.  Let $q$ be the maximum integer such that $S_i$ is non-empty.  Since $1\le |S_q|\le n/2^q$, $q\le \log_2 n$.  For each $i\in\{0,\ldots,q\}$, let $L_i:=S_i\setminus S_{i+1}$.  (These notations are mnemonics: $S_i$ are the \defin{survivors} of round $i-1$ and $L_i$ is \defin{layer} $i$.)

  Let $a:=3/2$ and $b:=1/2$.  We compute our colouring using a two phase algorithm. In the first phase we use a sequence of pairwise-disjoint color palettes $\Phi_0,\ldots,\Phi_{q}$, each of size $2k:=2d^{a}\sqrt{\Delta}\log^{b}n$, such that for each $1\le i < j\le k$, every colour in $\Phi_i$ is less than every colour in $\Phi_j$.  We will use the colours in $\Phi_i$ to colour the vertices in $L_i$, for each $i\in\{0,\ldots,q\}$.  The total number of colours used in this phase is $2k(q+1)\le 2k(1+\log n)= O(k\log n)$.

  We say that a vertex $y$ of $G$ is \defin{problematic} if $y$ has a neighbour in $G$ that receives the same colour as $y$ in the first phase or if $G$ contains a path $vyw$ such that $y\in L_i$, $u,w\in L_j$, $i \le j$ and $u$ and $w$ receive the same colour in the first phase. Note that any violation of the unique-superior colouring conditions is either an edge $yw$ with $\varphi(y)=\varphi(w)$ or a path $uyw$ with $\varphi(u)=\varphi(w)>\varphi(y)$.  In either case, the vertex $y$ is problematic and this violation could be fixed by recolouring $y$ with a sufficiently large colour, which is what the second phase of the algorithm does.

  For each $i\in\{0,\ldots,q\}$, fix an arbitrary total order $<_i$ on the vertices of $L_i$. Define the total order $<$ on $V(G)$ in which $v <w$ if $v\in L_i$, $w\in L_j$, and $i<j$ or if $v,w\in L_i$ and $v<_iw$. Let $H$ be the directed acyclic graph obtained from $G^2$ by directing each edge $vw$ as $\overrightarrow{vw}$ so that $v<w$.  In the discussion that follows, we will use the directed graph notations $N^+_G(v)$ and $\deg^+_G(v)$.  When we do so, we are referring to the directed acyclic graph obtained by orienting each edge $vw$ of $G$ as $\overrightarrow{vw}$ so that $v<w$.

  First we observe that $\deg^+_G(v)< 4d$ for any vertex $v$ of $G$. Indeed, a vertex $v$ is contained in $L_i$ precisely because $\deg_{G[S_i]}(v)<4d$.  The bound on $\deg^+_G(v)$ then follows from the fact that $N^+_{G}(v)\subseteq N_{G[S_i]}(v)$.  Next we claim that for each vertex $v$ of $G$, $\deg^+_{H}(v)\le (4d-1)(2\Delta+1)$.  To see this, suppose $v\in L_i$ and consider some edge $\overrightarrow{vw}$ of $H$.  Then  $\overrightarrow{vw}$ is of one of the following types:
  \begin{compactenum}[(T1)]
    \item $vw\in E(G)$ and $v<w$. Edges of this type contribute at most $\deg^+_{G}(v)\le 4d-1$ to $\deg^+_{H}(v)$.
    \item $G$ contains a path $vyw$ with $y < v < w$ or $v < y < w$.  Since $\deg_G(v)\le\Delta$, there are at most $\Delta$ choices for $y$.  For each such $y$, $w\in N^+_G(y)$ (since $y<w$), so there are at most $4d-1$ choices for $w$.  Therefore, edges of this type contribute at most $(4d-1)\Delta$ to the out-degree of $v$.
    \item $G$ contains a path $vyw$ with $v < w < y$.  Since $v<y$, $y\in N_G^+(v)$, so there are at most $4d-1$ choices for $y$ and for each such $y$, $\deg_G(y)\le\Delta$, so there are at most $\Delta$ choices for $w$.  Therefore, edges of this type contribute at most $(4d-1)\Delta$ to the out-degree of $v$.
  \end{compactenum}
  In the first phase of colouring, we colour the vertices of $G$ in the order given by $<$.  Immediately before colouring some vertex $w\in L_i$ we count, for each colour $\alpha\in \Phi_i$, the number $N_\alpha(w)$ of neighbours $y\in N^-_G(w)$ such that $y$ has colour $\alpha$ or $y$ already has a neighbour $u$ of colour $\alpha$. Observe that $\sum_{\alpha\in \Phi_i} N_\alpha(w)\le 4d|N^-_G(w)|< 4d\Delta$ since there are at most $|N^-_G(w)|\le\Delta$ choices for $y$ and for each $y$ there are at most $4d-1$ choices for $u$.  (Since any $u$ coloured with $\alpha\in\Phi_i$ must be in $S_i$, the number of such $u$ is at most $|N_G(y)\cap S_i|\le 4d$, since $y < w$ and $w\in S_i$.)

  We choose the colour of $w$ uniformly at random from a subpalette of $\Phi_i$ that contains exactly half the colours in $\Phi_i$.  Specifically we choose from a palette $\Phi_w\subset \Phi_i$ that contains the $k$ colours $\alpha$ in $\Phi_i$ with the smallest $N_\alpha(w)$ values, so that  $\max\{N_\alpha(w):\alpha\in \Phi_w\}\le\min\{N_\alpha(w):\alpha\in\Phi_i\setminus\Phi_w\}$.  Let $M:=4d\Delta/k$.  Then
  \[
    Mk = 4d\Delta \ge 4d|N^-_G(w)| \ge \sum_{\alpha\in \Phi_i} N_\alpha(w) \ge \sum_{\alpha\in\Phi_i\setminus\Phi_w}N_\alpha(w) \ge k\max\{N_\alpha(w):\alpha\in \Phi_w\} \enspace ,
  \]
  so that $\max\{N_\alpha(w):\alpha\in \Phi_w\}\le M$.  This completes the description of the first-phase colouring $\varphi$ of $G$.

  At this point, we can offer some justification for the definition of the colour set $\Phi_w$ that we choose from when colouring $w$. For each problematic vertex $y$, there exists a minimum vertex $w$ (with respect to $<$) such that $y$ becomes problematic precisely when $w$ is coloured.  When this happens, we say that $w$ \defin{completes} $y$. By definition, if $w$ chooses the colour $\alpha\in\Phi_w$, then it completes at most $N_{\alpha}(w)+1\le M$ vertices.  (The additional ${}+1$ here comes from the fact that $w$ can complete itself, which occurs when $w$ chooses the same colour as one of its neighbours.) Thus, $M$ is an upper bound on the number of problematic vertices that can be created by colouring any single vertex $w$.

  Let $P$ be the set of all problematic vertices in $G$.  In the second phase, we re-colour every vertex in $P$ with a colour in a palette $\Phi_{q+1}$ of size $ck\log n + 1$ whose colours are all larger than all colours in $\Phi_0,\ldots,\Phi_q$.  Since we are recolouring vertices in $P$ with large colours in $\Phi_{q+1}$, any violations of the unique-superior colouring conditions after the second phase must be caused by paths (with two or three vertices) whose endpoints are in $P$ and that receive the same colour.  In order to avoid these we will properly colour $G^2[P]$.  To show that this is possible, we will prove that, with positive probability, after the first phase, the maximum out-degree of any vertex in $H[P]$ is at most $ck\log n$.  Therefore there is some assignment of colours in phase one in which the maximum out-degree of $H[P]$ is at most $ck\log n$.  Therefore $H[P]$ is an acyclic orientation of $G^2[P]$ with maximum out-degree $ck\log n$, so $G^2[P]$ is $(ck\log n)$-degenerate.  Therefore, the $ck\log n + 1$ colours in $\Phi_{q+1}$ are sufficient to properly colour $G^2[P]$.

  We now focus on an arbitrary vertex $p$ in $G$ and show that after the first phase, $|N^+_{H}(p)\cap P|\le ck\log n$ with probability $1-n^{-\Omega(c)}$.  The union bound then implies that, with probability $1-n^{-\Omega(c)}$, $|N^+_{H}[p]\cap P|\le ck\log n$ for every $p\in V(G)$.  Since $P\subseteq V(G)$, this implies that, with probability $1-n^{-\Omega(c)}$, the maximum out-degree in $H[P]$ is at most $ck\log n$.
  % In particular, it implies that there exists a colouring of $G$ using the $O(k\log n)$ colours in $\Phi_0,\ldots,\Phi_q$ with this property.

  Fix an arbitrary vertex $p$ of $G$ and suppose $p\in L_i$. We are interested in the number of problematic vertices in $N_H^+(p)$.  Let $C_p:=\bigcup_{y\in N^+_H(p)} N^+_G[y]$, which is the set of all vertices $w$ that could complete some vertex $y\in N^+_H(p)$. For each $w\in C_p$, let
  $C_{p,w}:=N_H^+(p)\cap N_G^-[w]$, which is the set of vertices in $N^+_{H}(p)$ that $w$ could potentially complete. For each $w\in C_p$, let $\comp(p,w):=\{y\in C_{p,w}:\text{$w$ completes $y$}\}$.  For each $\alpha\in\Phi_w$, let $\comp'_\alpha(p,w)$ contain exactly those vertices $y\in C_{p,w}$ that have colour $\alpha$ or have a neighbour of colour $\alpha$ immediately before choosing the colour of $w$.  Observe that $\comp'_\alpha(p,w)$ contains every $y\in C_{p,w}$ that would be completed by $w$ if we were to set the colour of $w$ to $\alpha$ (as well as some additional vertices that may have already been completed by vertices in $C_p$ that were coloured before $w$).

  Recall that $N_\alpha(w)$ counts the number of neighbours $y$ of $w$ such that $y < w$ and $y$ has colour $\alpha$ or has a neighbour of colour $\alpha$ immediately before we choose the colour of $w$.  Therefore,  $|\comp'_\alpha(p,w)|\le N_\alpha(w)+1\le M$ for each $\alpha\in\Phi_w$.  Now let $\alpha\in\Phi_w$ be the colour that is actually chosen for $w$ and let $\comp'(p,w):=\comp'_\alpha(p,w)$.  We want to study the random variable $X'_{p,w}:=|\comp'(p,w)|\ge |\comp(p,w)|$.  Since $\alpha$ is chosen from $\Phi_w$, $X'_{p,w} \le M$.

  Let $\alpha_1,\ldots,\alpha_t$ be the colours in $\Phi_w$ ordered so that,
  \[
    |\comp'_{\alpha_1}(p,w)|\ge|\comp'_{\alpha_2}(p,w)|\ge\cdots\ge |\comp'_{\alpha_t}(p,w)| \enspace .
  \]
  Immediately before colouring $w\in L_i$, each $y\in C_{p,w}$ is assigned a colour (possibly in $\Phi_i$) and has at most $4d-2$ neighbours that have already received a colour in $\Phi_i$.  Therefore, $y$ appears in
  $\comp'_{\alpha}(p,w)$ for at most $4d-1$ values of $\alpha$, so
  \[
    \sum_{\alpha\in\Phi_w} |\comp'_{\alpha}(p,w)| \le 4d| C_{p,w}| \enspace .
  \]
  Therefore $i|\comp'_{\alpha_i}(p,w)|\le\sum_{j=1}^i|\comp'_{\alpha_j}(p,w)|\le 4d|C_{p,w}|$, so
  \[
    |\comp'_{\alpha_i}(p,w)|\le \frac{4d|C_{p,w}|}{i} \enspace .
  \]
  Therefore, regardless of any random choices made before choosing the colour of $w$ and any random choices made after choosing the colour of $w$, the random variable $X'_{p,w}$ is dominated by a random variable $X_{p,w}:=\min\{4d|C_{p,w}|/j,M\}$ where $j$ is chosen uniformly in $\{1,\ldots,k\}$.

  Therefore, $|N_H^+(p)\cap P|$ is dominated by a sum $X_p:=\sum_{w\in C_p} X_{p,w}$ of independent random variables.  We would like to apply a concentration result to the random variable $X$.  For this, we need to  establish sufficiently strong properties on the individual terms $X_{p,w}$, $w\in C_p$.  Thus far, we know that $0\le X_{p,w}\le M$ for each $w\in C_p$. In the appendix, we bound the expectation and variance of each $X_{p,w}$ so that we can apply a Bernstein Inequality to prove that $\Pr(X\ge ck\log n)\le n^{-\Omega(c)}$.  Thus, the number of additional colours in $\Phi_{q+1}$ needed to recolour $P$ in the second phase is $O(k\log n)$.  Thus, In this way, the total number of colours used is $O(k\log n)$, so
  \[
    \trn(G) \le O(k \log n) = O(d^a\sqrt{\Delta}\log^{1+b} n) = O(d^{3/2}\sqrt{\Delta}\log^{3/2} n) \enspace . \qedhere
  \]
\end{proof}

\section{Generalization to $\ell$-Vertex-Ranking}

The same proof used to establish \cref{degenerate_and_degree} establishes the following generalization:

\begin{thm}\label{l_degenerate_and_degree}
  For any positive integers $d$ and $\ell$ there exists a constant $c:=c(d,\ell)$ such that, for all integers $\Delta\ge d$ and $n\ge \Delta$, every $n$-vertex $d$-degenerate graph $G$ of maximum degree $\Delta$ has $\lrn(G)\le c\Delta^{\ell-3/2}\log n$.
\end{thm}

\begin{proof}[Proof Sketch]
  Let $G$ be an $n$-vertex $d$-degenerate graph of maximum degree $\Delta$ and let $k:=\Delta^{\ell-3/2}$. Proceed exactly as in the proof of \cref{degenerate_and_degree} by partitioning $V(G)$ into the sets $L_0,\ldots,L_q$ and defining the total order $<$ as before.  In the first phase, the vertices in $L_i$ will receive colours from a palette $\Phi_i$ of size $2k$, so the first phase will use at most $k(q+1)=O(k\log n)$ colours.

  Now, define $H$ as the oriented version of $G^{\ell}$ where the orientation of each edge is given by $<$.  As before, consider an oriented version of $G$ with orientations also given by $<$.  Observe that, for every directed edge $\overrightarrow{py}$ of $H$, $G$ contains a (undirected) path of length at most $\ell$ that begins at $p$, ends at $y$, and traverses at least one edge of $G$ in the direction it is oriented.  The number of such paths is $O(\Delta^{\ell-1})$.

  A vertex $y\in L_i$ is \defin{problematic} if, after the first phase, there exist a path $\Pi$ of length at most $\ell$ that begins at a vertex $u\in L_j$, $j\ge i$, contains $y$, ends at a vertex $w\in L_j$ that receives the same colour as $u$.  (This includes the possibility that $u=y$.)  Consider the number of paths $\Pi$ that could result in $y$ being problematic. Any such $\Pi$ is the union of two paths $y\rightsquigarrow u$ and $y\rightsquigarrow w$ of lengths $a$ and $b$, respectively, where $0\le a\le b$ and $1\le a+b\le\ell$. The fact that $y\in L_i$ and $u,w\in L_j$ implies that, for a fixed $a$ and $b$, the number of such paths $\Pi$ is at most $O(\Delta^{a-1}\cdot\Delta^{b-1})=O(\Delta^{\ell-2})$. Summing over all choices of path length $1\le r\le \ell$ and $0\le a\le \lfloor r/2\rfloor$ only increases this count by a factor of $O(\ell)=O(1)$.

  When colouring a vertex $w$ choose the colour of $w$ randomly from a $k$-colour subpalette $\Phi_w\subseteq \Phi_i$ chosen to minimize the maximum number $M$ of vertices that could become problematic by choosing $\varphi(w)\in \Phi_w$.  If $w\in L_j$, then each such $y$ is in $\bigcup_{i=0}^{j} L_i$, and is contained in a path of length at most $\ell$ that begins at $u\in L_j$, contains $y$ and ends at $w\in L_j$.  For a fixed $w$, the number of such paths is $O(\Delta^{\ell-1})$. For each such path $\Pi$, there is at most one colour $\alpha$ (the colour assigned to $u$) such that assigning the colour $\alpha$ to $w$ makes $y$ problematic because of $\Pi$.  This implies that $Mk \le O(\Delta^{\ell-1})$, so $M\le O(\Delta^{\ell-1}/k)=O(\sqrt{\Delta})$.

  Now we fix some vertex $p$ and study the random variable $X_p:=|N^+_H(p)\cap P|$ where $P$ is the set of problematic vertices after the first phase.  Then $X_p$ is a sum of random variables $\sum_{w>p} X'_{p,w}$ where $X'_{p,w}$ is the number of vertices in $N^+_H(p)$ that become problematic precisely when $w$ is coloured.  For $w\in L_i$, $X'_{p,w}$ is dominated by a random variable $X_{p,w}$ that is distributed like $\min\{M,x_w/j\}$ where $j$ is uniform in $\{1,\ldots,k\}$ and $x_w$ counts the number of paths of length at most $\ell$ that begin at some vertex $u\in L_j$, contain some vertex $y\in N^+_H(p)\cap \bigcup_{i=1}^j L_j$ and end at $w\in L_j$.  As discussed above, for each $y\in N^+_H(p)$, the number of such paths is $O(\Delta^{\ell-2})$.  Therefore, $\sum_{w>p} x_w\le |N^+_H(p)|\cdot O(\Delta^{\ell-2})=O(\Delta^{2\ell-3})$.  Therefore, the random varable $X_p$ is dominated by $X:=\sum_{w>p} X_{p,w}$. The same calculation used in the appendix then shows that
  \[
    \E(X) \le O\left(\frac{\Delta^{2\ell-3}\log n}{k}\right)
    = O\left(\frac{\Delta^{2\ell-3}\log n}{\Delta^{\ell-3/2}}\right)
    =  O\left(\Delta^{\ell-3/2}\log n})=O(k\log n) \enspace .
  \]
  More calculations almost identical to those that appear in the appendix show that $\Pr(X_p)\ge ck\log n=n^{-\Omega(c)}$.  Thus, with high probability, the graph $G^{\ell}[P]$ is $O(k\log n)$-degenerate so the vertices in $P$ can be re-coloured using an additional $O(k\log n)$ colours.
\end{proof}

Again \cref{l_degenerate_and_degree} quickly establishes \cref{l_d_degenerate_upper_bound}, as follows:  Let $G$ be any $n$-vertex $d$-degenerate graph and let $\Delta=n^{1/(\ell-1/2)}$.  Then the set $S:=\{v\in V(G):\deg_G(v)\ge \Delta\}$ has size at most $2dn/\Delta=O(n^{1-1/(\ell-1/2)})=O(n^{(\ell-3/2)/(\ell-1/2)})$.  Since $G-S$ has maximum degree $\Delta$, $G-S$ has a unique-superior colouring $\varphi$ using at most
\[
  c\Delta^{\ell-3/2}\log n
  % = c\cdot \sqrt{\frac{n^{2/3}}{d^{1/3}\log^{1/2} n}}\cdot \log^{3/4} n
  = c\cdot n^{(\ell-3/2)/(\ell-1/2)}\log n
\]
 colours, by \cref{l_degenerate_and_degree}. We can extend $\varphi$ to a colouring of $G$ by assigning each vertex in $S$ a distinct colour that is larger than every colour used in the colouring of $G-S$.  Thus, $\trn(G)\le |S|+\trn(G-S)\le O(n^{(\ell-3/2)/(\ell-1/2)})$, which establishes \cref{l_d_degenerate_upper_bound}.

\todo[inline]{Can we prove a lower bound of $\Omega(n^{(\ell-3/2)/(\ell-1/2)})$? How about $n^{1-O(1/\ell)}$?}

\bibliographystyle{plainnat}
\bibliography{us2}

\appendix

\section{Bounding the Tail of \boldmath$|N_H^+(v)|$}

We make use of the following inequality of Bernstein \cite[Corollary~2.11]{boucheron.lugosi.ea:concentration}:

\begin{thm}\label{bernstein_theorem}
  Let $M$ be a positive number, let $X_1,\ldots,X_r$ be independent random variables such that $0\le X_i\le M$ for each $i\in\{1,\ldots,r\}$, and let $X:=\sum_{i=1}^r X_i$. Then
  \begin{equation}
    \Pr\left(X \ge \E(X)+ t\right)
      \le \exp\left(\frac{\tfrac{1}{2}t^2}{\sum_{i=1}^r \E((X_i-\E(X_i))^2)+\tfrac{1}{3}Mt}\right) \enspace . \label{bernstein}
  \end{equation}
\end{thm}
We will apply \cref{bernstein_theorem} to a random variable $X:=\sum_{i=1}^r X_i$ in which each $X_i$ has the following distribution (for some $0\le x_i\le kM$):
\[
  X_i = \begin{cases}
          M & \text{with probability $(1/k)\lfloor x_1/M\rfloor$} \\
          x_i/j & \text{with probability $1/k$ for $j\in\{\lfloor x_i/M\rfloor+1,\ldots,k\}$}
        \end{cases}
\]
This is the distribution we get when we choose a uniform $j\in\{1,\ldots,k\}$ and set $X_i:=\min\{M,x_i/j)$.  To see how this applies in the proof of \cref{degenerate_and_degree}, let $\{w_1,\ldots,w_n\}:=C_p$, and let $x_i:=4d|C_{p,w_i}|$.  In our setting $k=d^a\sqrt{\Delta}\log^b n$ for some constants $a,b>0$, $M=4d\Delta/k$ and $t=ck\log n$ for some (sufficiently large) constant $c$.  The rest of this appendix is devoted to bounding the various quantities that appear in \cref{bernstein} so that we can show that the right-hand side of \cref{bernstein} is $n^{-\Omega(c)}$.    By the end of the appendix, we will have shown that the constants $a=3/2$ and $b=1/2$ satisfy our requirements.

Both the maximum value and the sum of $x_1,\ldots,x_n$ are important for us.  Since $C_{p,w_i}\subseteq N_G(w_i)$, we have $x_i\le 4d\deg_G(w_i)\le 4d\Delta$ for all $i\in\{1,\ldots,r\}$, so $\max\{x_1,\ldots,x_r\}\le 4d\Delta$. The sum can be bounded by
\[
  \sum_{i=1}^n x_i
    = \sum_{i=1}^n 4d|C_{v,w_i}|
    \le 4d\cdot \sum_{y\in N^+_{H}(p)} |N^+_G[y]|
    \le 16d^2|N^+_{H}(p)|=O(d^3\Delta)
  \enspace .
\]
Then we have
\begin{align*}
  \E(X_i)
  & =\Pr(X_i=M)\cdot M + \sum_{j=\lfloor x_i/M\rfloor+1}^k \Pr(X_i=j)\cdot\frac{x_i}{j} \\
  & \le\frac{x_i}{kM}\cdot M + \frac{1}{k}\cdot\sum_{j=\lfloor x_i/M\rfloor+1}^k \frac{x_i}{j} \\
  & \le\frac{x_i}{k} + \frac{1}{k}\cdot\sum_{j=1}^k \frac{x_i}{j} \\
  % & = \frac{x_i}{k} + \frac{x_i}{k}(H_{k}-H_{x_i/M}) \\
  % & \le \frac{x_i}{k}(1+H_{k}) \\
  & \le \frac{x_i(2+\ln k)}{k} \\
  % & = O\left(\frac{x_i}{k}+\frac{x_i\log k}{k}\right) \\
  & = O\left(\frac{x_i\log k}{k}\right) \\
  & = O\left(\frac{x_i\log n}{k}\right)
  \enspace ,
\end{align*}
where the last line comes from the fact that $d,\Delta \le n$.
Therefore,
\begin{align*}
  (\E(X_i))^2
  & = O\left(\left(\frac{x_i\log n}{k}\right)^2\right) \\
  & = O\left(\frac{x_i^2\log^2 n}{k^2}\right) \\
  & = O\left(\frac{x_i^2\log^2 n}{d^{2a}\Delta\log^{2b}\Delta}\right) \\
  % & = O\left(\frac{x_i^2\log^{2-2?} \Delta}{d\Delta}\right) \\
  & = O(d^{1-2a}x_i\log^{2-2b} n) \enspace .
\end{align*}
Recall that $M:=4d\Delta/k=4d^{1-a}\sqrt{\Delta}\log^{-b}n$. Therefore,
\begin{align*}
  \E((X_i-\E(X_i))^2)
  & = \frac{1}{k}\left\lfloor\frac{x_i}{M}\right\rfloor\cdot(M-\E(X_i))^2
    + \sum_{j=\lfloor x_i/M\rfloor+1}^k \frac{1}{k}\left(\frac{x_i}{j}-\E(X_i)\right)^2 \\
  & \le \frac{x_i}{kM}\left(M^2 + (\E(X_i))^2\right)
    + \sum_{j=\lfloor x_i/M\rfloor+1}^k \frac{1}{k}\left(\frac{x_i^2}{j^2}+(\E(X_i))^2\right) \\
  & \le \frac{M x_i}{k} + \left(\frac{x_i}{kM}+1\right)\cdot (\E(X_i))^2
      + \frac{1}{k}\sum_{j=\lfloor x_i/M\rfloor+1}^k \frac{x_i^2}{j^2} \\
  & \le \frac{M x_i}{k} + \left(\frac{x_i}{kM}+1\right)\cdot (\E(X_i))^2
      +  \frac{1}{k}\cdot\frac{M\pi^2x_i^2}{6 x_i}
     & \text{(since $\sum_{j=a}^{\infty} \tfrac{1}{j^2} \le \tfrac{\pi^2}{6a}$ for $a\ge 1$)} \\
  & = \frac{M x_i}{k}\cdot\left(1+\frac{\pi^2}{6}\right) + \left(\frac{x_i}{kM}+1\right)\cdot (\E(X_i))^2 \\
  & \le \frac{M x_i}{k}\cdot\left(1+\frac{\pi^2}{6}\right) + 2\cdot (\E(X_i))^2   & \text{(since $x_i\le 4d\Delta=kM$)} \\
 & = O(d^{1-2a}x_i\log^{-2b}n) + O(d^{1-2a}\log^{2-2b} n) \\
  & = O(d^{1-2a}x_i\log^{2-2b}n) \enspace .
\end{align*}
Recall that $\sum_{i=1}^r x_i = O(d^3\Delta)$, so
\[
  \E(X)
  = \sum_{i=1}^r \E(X_i)
  = \sum_{i=1}^r O\left(\frac{x_i\log n}{k}\right)
  = O\left(\frac{d^3\Delta\log n}{k}\right)
  = O\left(d^{3-a}\sqrt{\Delta}\log^{1-b} n\right) \enspace .
\]
and
\[
  \sum_{i=1}^r\E((X_i-\E(X_i))^2)
  = \sum_{i=1}^r O(d^{1-2a}x_i\log^{2-2b} n)
  = O(d^{4-2a}\Delta\log^{2-2b} n)  \enspace .
\]
Then \cref{bernstein} gives:
\begin{align*}
  \Pr(X\ge \E(X)+t)
  & = \Pr(X\ge \E(X)+ck\log n) \\
  & \le \exp \left(-\frac{\tfrac{1}{2}(ck\log n)^2}{O(d^{4-2a}\Delta\log^{2-2b}n) + \tfrac{1}{3}Mck\log n}\right) \\
  & = \exp \left(-\frac{\tfrac{1}{2}(ck\log n)^2}{O(d^{4-2a}\Delta\log^{2-2b}n) + \tfrac{4}{3}cd\Delta\log n}\right)
    & \text{(since $Mk=4d\Delta$)} \\
  % & = \exp \left(-\frac{\tfrac{1}{2}(ck)^2}{O(d^{4-2a}\Delta\log^{2-2b}n) + \tfrac{4}{3}cd\Delta}\right) \\
  & \le \exp \left(-\frac{\tfrac{1}{2}(ck\log n)^2}{O(cd^{4-2a}\Delta\log^{2-2b}n) + \tfrac{4}{3}cd\Delta\log n}\right)
  & \text{(since $c\ge 1$)}\\
  & \le \exp \left(-\frac{\tfrac{1}{2}(ck\log n)^2}{O(cd^{4-2a}\Delta\log^{2-2b}n) + \tfrac{4}{3}cd^{4-2a}\Delta\log n}\right)
  & \text{(for $a\le 3/2$)}\\
  & \le \exp \left(-\frac{\tfrac{1}{2}(ck\log n)^2}{O(cd^{4-2a}\Delta\log^{2-2b}n) + \tfrac{4}{3}cd^{4-2a}\Delta\log^{2-2b}n}\right)
  & \text{(for $b\le 1/2$)}\\
  & = \exp \left(-\frac{\tfrac{1}{2}(c^2d^{2a}\Delta\log^{2+2b} n)}{O(cd^{4-2a}\Delta\log^{2-2b}n) + \tfrac{4}{3}cd^{4-2a}\Delta\log^{2-2b}n}\right) \\
  & = \exp \left(-\Omega\left(cd^{4a-4}\log^{4b}n\right)\right) \\
  & \le \exp \left(-\Omega\left(c\log^{4b}n\right)\right)
  & \text{(for $a\ge 1$)}\\
  & \le \exp \left(-\Omega\left(c\log n\right)\right)
  & \text{(for $b\ge 1/4$)}\\
  & = n^{-\Omega(c)} \enspace .
\end{align*}
This calculations assumes that $1\le a\le 3/2$ and that $1/4\le b\le 1/2$.  In particular, $a:=3/2$ and $b:=1/2$ satisfy these requirements.  For any fixed $c$,
\begin{align*}
  \E(X)+t
    & = O(d^3\Delta\log n/k + k\log n) \\
    & = O(d^{3-a}\sqrt{\Delta}\log^{1-b} n + d^a\sqrt{\Delta}\log^{1+b} n) \\
    & = O(d^{3/2}\sqrt{\Delta}\log^{3/2}n) \enspace .
  % = O(d^{3/2}\log^{1/4} n + d^{3/2}\log^{3/4} n)
  % = O(d^{3/2}\log^{3/4} n)  \enspace .
\end{align*}
Thus, $\Pr(X\ge cd^{3/2}\sqrt{\Delta}\log^{3/2} n) \le n^{-\Omega(c)}$, which completes the proof of \cref{degenerate_and_degree}.
\end{document}
